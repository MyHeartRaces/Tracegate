#!/usr/sbin/nft -f

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0;
    policy drop;

    iif "lo" accept
    ct state established,related accept

    # Keep management access available.
    tcp dport 22 accept

    # Public data-plane.
    tcp dport 443 accept
    udp dport { 443, 51820 } accept

    # k3s inter-node traffic from VPS-E.
    ip saddr 178.250.243.46 tcp dport { 6443, 10250 } accept
    ip saddr 178.250.243.46 udp dport 8472 accept

    # Agent API is internal-only.
    ip saddr 178.250.243.46 tcp dport 8070 accept
    # Allow pod-to-apiserver traffic (CoreDNS -> kubernetes.default.svc) and agent API.
    ip saddr 10.42.0.0/16 tcp dport { 6443, 8070 } accept

    ip protocol icmp accept
    meta l4proto ipv6-icmp accept
  }

  chain forward {
    type filter hook forward priority 0;
    policy drop;
    ct state established,related accept
    # Allow k3s pod networking and service routing (DNS/API).
    ip saddr 10.42.0.0/16 accept
    ip daddr 10.42.0.0/16 accept
    iif "wg0" accept
  }

  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}

table ip nat {
  chain postrouting {
    type nat hook postrouting priority 100;
    oifname "eth0" ip saddr 10.70.0.0/24 masquerade
  }
}
