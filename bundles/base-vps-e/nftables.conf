#!/usr/sbin/nft -f

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0;
    policy drop;

    iif "lo" accept
    ct state established,related accept

    # Keep management access available.
    tcp dport 22 accept

    # Public data-plane.
    tcp dport 443 accept
    udp dport 443 accept

    # k3s inter-node traffic from VPS-T.
    ip saddr 46.226.165.23 udp dport 8472 accept
    ip saddr 46.226.165.23 tcp dport 10250 accept

    # Agent API is internal-only.
    ip saddr 46.226.165.23 tcp dport 8070 accept
    ip saddr 10.42.0.0/16 tcp dport 8070 accept

    ip protocol icmp accept
    meta l4proto ipv6-icmp accept
  }

  chain forward {
    type filter hook forward priority 0;
    policy drop;
    ct state established,related accept
    # Allow k3s pod networking and service routing (DNS/API).
    ip saddr 10.42.0.0/16 accept
    ip daddr 10.42.0.0/16 accept
  }

  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}
