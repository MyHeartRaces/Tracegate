{{- if .Values.observability.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["nodes", "nodes/proxy", "pods", "services", "endpoints", "namespaces"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
subjects:
  - kind: ServiceAccount
    name: {{ include "tracegate.fullname" . }}-prometheus
    namespace: {{ include "tracegate.namespace" . }}
roleRef:
  kind: ClusterRole
  name: {{ include "tracegate.fullname" . }}-prometheus
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus-config
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.observability.prometheus.scrapeInterval | default "15s" }}
      evaluation_interval: {{ .Values.observability.prometheus.scrapeInterval | default "15s" }}
    rule_files:
      - /etc/prometheus/tracegate-rules.yml

    scrape_configs:
      - job_name: tracegate-api
        metrics_path: /metrics
        scheme: http
        bearer_token_file: /etc/prometheus/secrets/api-internal-token
        static_configs:
          - targets:
              - {{ printf "%s-api:%d" (include "tracegate.fullname" .) (int .Values.controlPlane.service.port) }}

      {{- if .Values.controlPlane.dispatcherMetrics.enabled }}
      - job_name: tracegate-dispatcher
        metrics_path: /metrics
        scheme: http
        static_configs:
          - targets:
              - {{ printf "%s-dispatcher:%d" (include "tracegate.fullname" .) (int (.Values.controlPlane.dispatcherMetrics.port | default 9091)) }}
      {{- end }}

      {{- if and (gt (int .Values.controlPlane.replicas.bot) 0) (.Values.controlPlane.botMetrics.enabled | default true) }}
      - job_name: tracegate-bot
        metrics_path: /metrics
        scheme: http
        static_configs:
          - targets:
              - {{ printf "%s-bot-metrics:%d" (include "tracegate.fullname" .) (int (.Values.controlPlane.botMetrics.port | default 9092)) }}
      {{- end }}

      - job_name: tracegate-agent
        metrics_path: /metrics
        scheme: http
        bearer_token_file: /etc/prometheus/secrets/agent-auth-token
        static_configs:
          - targets:
              - {{ printf "%s-agent-vps-t:%d" (include "tracegate.fullname" .) (int .Values.gateway.vpsT.agent.port) }}
              - {{ printf "%s-agent-vps-e:%d" (include "tracegate.fullname" .) (int .Values.gateway.vpsE.agent.port) }}

      - job_name: tracegate-node-exporter
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: [{{ include "tracegate.namespace" . | quote }}]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_tracegate_component]
            regex: node-exporter
            action: keep
          - source_labels: [__meta_kubernetes_pod_ip]
            regex: (.+)
            target_label: __address__
            replacement: ${1}:9100

      - job_name: tracegate-cadvisor
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: [{{ include "tracegate.namespace" . | quote }}]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_tracegate_component]
            regex: cadvisor
            action: keep
          - source_labels: [__meta_kubernetes_pod_ip]
            regex: (.+)
            target_label: __address__
            replacement: ${1}:8080
  tracegate-rules.yml: |
    groups:
      - name: tracegate-slo
        interval: {{ .Values.observability.prometheus.scrapeInterval | default "15s" }}
        rules:
          - record: tracegate_slo_component_up_ratio_5m
            expr: avg_over_time(up{job=~"tracegate-api|tracegate-dispatcher|tracegate-bot|tracegate-agent"}[5m])

          - record: tracegate_slo_http_request_success_ratio_5m
            expr: |
              sum by (component) (rate(tracegate_http_requests_total{component=~"api|agent", status!~"5.."}[5m]))
              /
              sum by (component) (rate(tracegate_http_requests_total{component=~"api|agent"}[5m]))

          - record: tracegate_slo_http_request_latency_p95_seconds_5m
            expr: |
              histogram_quantile(
                0.95,
                sum by (component, le) (rate(tracegate_http_request_duration_seconds_bucket{component=~"api|agent"}[5m]))
              )

          - record: tracegate_slo_bot_update_success_ratio_5m
            expr: |
              sum(rate(tracegate_bot_updates_total{result="ok"}[5m]))
              /
              sum(rate(tracegate_bot_updates_total[5m]))

          - record: tracegate_slo_bot_update_latency_p95_seconds_5m
            expr: |
              histogram_quantile(
                0.95,
                sum by (le) (rate(tracegate_bot_update_duration_seconds_bucket{result="ok"}[5m]))
              )
---
{{- if .Values.observability.prometheus.storage.enabled }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: {{ .Values.observability.prometheus.storage.size | quote }}
  {{- if .Values.observability.prometheus.storage.storageClassName }}
  storageClassName: {{ .Values.observability.prometheus.storage.storageClassName | quote }}
  {{- end }}
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: observability
      app.kubernetes.io/name: prometheus
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        {{- include "tracegate.labels" . | nindent 8 }}
        app.kubernetes.io/component: observability
        app.kubernetes.io/name: prometheus
    spec:
      serviceAccountName: {{ include "tracegate.fullname" . }}-prometheus
      volumes:
        - name: config
          configMap:
            name: {{ include "tracegate.fullname" . }}-prometheus-config
        - name: secrets
          secret:
            secretName: {{ include "tracegate.fullname" . }}-control-plane-auth
        - name: data
          {{- if .Values.observability.prometheus.storage.enabled }}
          persistentVolumeClaim:
            claimName: {{ include "tracegate.fullname" . }}-prometheus
          {{- else }}
          emptyDir: {}
          {{- end }}
      containers:
        - name: prometheus
          image: {{ .Values.observability.prometheus.image }}
          imagePullPolicy: {{ .Values.observability.prometheus.pullPolicy }}
          args:
            - --config.file=/etc/prometheus/prometheus.yml
            - --storage.tsdb.path=/prometheus
            - --storage.tsdb.retention.time=15d
          ports:
            - name: http
              containerPort: 9090
          volumeMounts:
            - name: config
              mountPath: /etc/prometheus
            - name: secrets
              mountPath: /etc/prometheus/secrets
              readOnly: true
            - name: data
              mountPath: /prometheus
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "tracegate.fullname" . }}-prometheus
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9090
      targetPort: http
  selector:
    app.kubernetes.io/component: observability
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/instance: {{ .Release.Name }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "tracegate.fullname" . }}-grafana
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: observability
      app.kubernetes.io/name: grafana
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        {{- include "tracegate.labels" . | nindent 8 }}
        app.kubernetes.io/component: observability
        app.kubernetes.io/name: grafana
    spec:
      volumes:
        - name: data
          emptyDir: {}
      containers:
        - name: grafana
          image: {{ .Values.observability.grafana.image }}
          imagePullPolicy: {{ .Values.observability.grafana.pullPolicy }}
          ports:
            - name: http
              containerPort: 3000
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: "admin"
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "tracegate.fullname" . }}-grafana-auth
                  key: admin-password
            - name: GF_AUTH_PROXY_ENABLED
              value: "true"
            - name: GF_AUTH_PROXY_HEADER_NAME
              value: "X-WEBAUTH-USER"
            - name: GF_AUTH_PROXY_AUTO_SIGN_UP
              value: "true"
            - name: GF_USERS_AUTO_ASSIGN_ORG_ROLE
              value: "Viewer"
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
            - name: GF_AUTH_DISABLE_LOGIN_FORM
              value: "true"
            - name: GF_SERVER_ROOT_URL
              value: "%(protocol)s://%(domain)s/grafana/"
            - name: GF_SERVER_SERVE_FROM_SUB_PATH
              value: "true"
            - name: GF_EXPLORE_ENABLED
              value: "false"
          volumeMounts:
            - name: data
              mountPath: /var/lib/grafana
          resources:
            {{- toYaml .Values.observability.grafana.resources | nindent 12 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "tracegate.fullname" . }}-grafana
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
      targetPort: http
  selector:
    app.kubernetes.io/component: observability
    app.kubernetes.io/name: grafana
    app.kubernetes.io/instance: {{ .Release.Name }}
---
{{- if .Values.observability.nodeExporter.enabled }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "tracegate.fullname" . }}-node-exporter
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
    tracegate.component: node-exporter
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      tracegate.component: node-exporter
  template:
    metadata:
      labels:
        {{- include "tracegate.labels" . | nindent 8 }}
        app.kubernetes.io/component: observability
        tracegate.component: node-exporter
    spec:
      containers:
        - name: node-exporter
          image: {{ .Values.observability.nodeExporter.image }}
          imagePullPolicy: {{ .Values.observability.nodeExporter.pullPolicy }}
          args:
            - --path.procfs=/host/proc
            - --path.sysfs=/host/sys
            - --path.rootfs=/host/root
            - --web.listen-address=:9100
          ports:
            - name: metrics
              containerPort: 9100
              protocol: TCP
          volumeMounts:
            - name: proc
              mountPath: /host/proc
              readOnly: true
            - name: sys
              mountPath: /host/sys
              readOnly: true
            - name: root
              mountPath: /host/root
              readOnly: true
      volumes:
        - name: proc
          hostPath:
            path: /proc
        - name: sys
          hostPath:
            path: /sys
        - name: root
          hostPath:
            path: /
{{- end }}
---
{{- if .Values.observability.cadvisor.enabled }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "tracegate.fullname" . }}-cadvisor
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
    tracegate.component: cadvisor
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: {{ .Release.Name }}
      tracegate.component: cadvisor
  template:
    metadata:
      labels:
        {{- include "tracegate.labels" . | nindent 8 }}
        app.kubernetes.io/component: observability
        tracegate.component: cadvisor
    spec:
      containers:
        - name: cadvisor
          image: {{ .Values.observability.cadvisor.image }}
          imagePullPolicy: {{ .Values.observability.cadvisor.pullPolicy }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          securityContext:
            privileged: true
          volumeMounts:
            - name: root
              mountPath: /rootfs
              readOnly: true
            - name: var-run
              mountPath: /var/run
              readOnly: false
            - name: sys
              mountPath: /sys
              readOnly: true
            - name: containerd
              mountPath: /var/lib/containerd
              readOnly: true
            - name: kubelet
              mountPath: /var/lib/kubelet
              readOnly: true
      volumes:
        - name: root
          hostPath:
            path: /
        - name: var-run
          hostPath:
            path: /var/run
        - name: sys
          hostPath:
            path: /sys
        - name: containerd
          hostPath:
            path: /var/lib/containerd
        - name: kubelet
          hostPath:
            path: /var/lib/kubelet
{{- end }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "tracegate.fullname" . }}-grafana-bootstrap
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
    app.kubernetes.io/component: observability
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "tracegate.labels" . | nindent 8 }}
        app.kubernetes.io/component: observability
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: {{ include "tracegate.image" .Values.controlPlane.image }}
          imagePullPolicy: {{ .Values.controlPlane.image.pullPolicy }}
          command:
            - sh
            - -ec
            - |
              python3 -m tracegate.cli.grafana_bootstrap
          env:
            - name: GRAFANA_BASE_URL
              value: {{ printf "http://%s-grafana:3000" (include "tracegate.fullname" .) | quote }}
            - name: GRAFANA_ADMIN_USER
              value: "admin"
            - name: GRAFANA_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "tracegate.fullname" . }}-grafana-auth
                  key: admin-password
            - name: PROMETHEUS_URL
              value: {{ printf "http://%s-prometheus:9090" (include "tracegate.fullname" .) | quote }}
{{- end }}
