{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-decoy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  index.html: |
{{ .Values.gateway.vpsT.decoyHtml | nindent 4 }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled }}
{{- if eq .Values.gateway.vpsE.mode "tcpForward" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-haproxy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  haproxy.cfg: |
    global
      maxconn 1000

    defaults
      mode tcp
      option tcplog
      timeout connect 5s
      timeout client  2m
      timeout server  2m

    frontend fe_443
      bind :443
      default_backend be_transit

    backend be_transit
      server transit {{ .Values.gateway.vpsE.tcpForward.upstreamHost }}:{{ .Values.gateway.vpsE.tcpForward.upstreamPort }}

    {{ $wsPort := int (.Values.controlPlane.env.vlessWsTlsPort | default 443) }}
    {{ if ne $wsPort 443 }}

    frontend fe_{{ $wsPort }}
      bind :{{ $wsPort }}
      default_backend be_ws_tls

    backend be_ws_tls
      server transit_ws {{ .Values.gateway.vpsE.tcpForward.upstreamHost }}:{{ $wsPort }}
    {{ end }}
{{- end }}
{{- if eq .Values.gateway.vpsE.mode "xray" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-entry-mux
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    stream {
      map $ssl_preread_server_name $tg_upstream {
        default reality;
        {{- if .Values.gateway.vpsE.proxyFqdn }}
        "{{ .Values.gateway.vpsE.proxyFqdn }}" ws_tls;
        {{- end }}
        {{- range (.Values.gateway.vpsE.entryMux.wsSniHosts | default (list)) }}
        "{{ . }}" ws_tls;
        {{- end }}
      }

      upstream reality {
        server 127.0.0.1:2443;
      }

      upstream ws_tls {
        server 127.0.0.1:4443;
      }

      server {
        listen 0.0.0.0:443;
        proxy_timeout 1h;
        proxy_connect_timeout 1s;
        proxy_pass $tg_upstream;
        ssl_preread on;
      }
    }

    http {
      server {
        listen 127.0.0.1:4443 ssl;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        location /healthz {
          return 200 "ok\n";
        }

        location {{ .Values.controlPlane.env.vlessWsPath | default "/ws" }} {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://127.0.0.1:10000;
        }
      }
    }
{{- end }}
{{- end }}
