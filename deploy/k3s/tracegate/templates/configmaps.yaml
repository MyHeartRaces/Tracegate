{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled }}
{{- $publicBaseUrl := (.Values.controlPlane.env.publicBaseUrl | default "" | trim) -}}
{{- $publicBaseHost := "" -}}
{{- if $publicBaseUrl -}}
{{- $publicBaseHost = regexReplaceAll "^https?://([^/:]+).*$" $publicBaseUrl "${1}" -}}
{{- end -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-decoy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  index.html: |
{{ .Values.gateway.vpsT.decoyHtml | nindent 4 }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-entry-mux
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    stream {
      map $ssl_preread_server_name $tg_upstream {
        default reality;
        {{- if .Values.gateway.vpsT.fqdn }}
        "{{ .Values.gateway.vpsT.fqdn }}" ws_tls;
        {{- end }}
        {{- if and .Values.gateway.vpsT.proxyFqdn (ne .Values.gateway.vpsT.proxyFqdn .Values.gateway.vpsT.fqdn) }}
        "{{ .Values.gateway.vpsT.proxyFqdn }}" ws_tls;
        {{- end }}
        {{- if and $publicBaseHost (ne $publicBaseHost .Values.gateway.vpsT.fqdn) (or (not .Values.gateway.vpsT.proxyFqdn) (ne $publicBaseHost .Values.gateway.vpsT.proxyFqdn)) }}
        "{{ $publicBaseHost }}" ws_tls;
        {{- end }}
        {{- range (.Values.gateway.vpsT.entryMux.wsSniHosts | default (list)) }}
        "{{ . }}" ws_tls;
        {{- end }}
      }

      upstream reality {
        server 127.0.0.1:2443;
      }

      upstream ws_tls {
        server 127.0.0.1:4443;
      }

      server {
        listen 0.0.0.0:443;
        proxy_timeout 1h;
        proxy_connect_timeout 1s;
        proxy_pass $tg_upstream;
        ssl_preread on;
      }
    }

    http {
      server {
        listen 127.0.0.1:4443 ssl;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        location /healthz {
          return 200 "ok\n";
        }

        location {{ .Values.controlPlane.env.vlessWsPath | default "/ws" }} {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://127.0.0.1:10000;
        }

        location = /grafana {
          return 302 /grafana/;
        }

        location ^~ /grafana/ {
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto https;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://{{ include "tracegate.fullname" . }}-api:{{ .Values.controlPlane.service.port }};
        }

        location / {
          return 200 "ok\n";
        }
      }
    }
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled }}
{{- if eq .Values.gateway.vpsE.mode "tcpForward" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-haproxy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  haproxy.cfg: |
    global
      maxconn 1000

    defaults
      mode tcp
      option tcplog
      timeout connect 5s
      timeout client  2m
      timeout server  2m

    frontend fe_443
      bind :443
      default_backend be_transit

    backend be_transit
      server transit {{ .Values.gateway.vpsE.tcpForward.upstreamHost }}:{{ .Values.gateway.vpsE.tcpForward.upstreamPort }}

    {{ $wsPort := int (.Values.controlPlane.env.vlessWsTlsPort | default 443) }}
    {{ if ne $wsPort 443 }}

    frontend fe_{{ $wsPort }}
      bind :{{ $wsPort }}
      default_backend be_ws_tls

    backend be_ws_tls
      server transit_ws {{ .Values.gateway.vpsE.tcpForward.upstreamHost }}:{{ $wsPort }}
    {{ end }}
{{- end }}
{{- if eq .Values.gateway.vpsE.mode "xray" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-entry-mux
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    stream {
      map $ssl_preread_server_name $tg_upstream {
        default reality;
        {{- if .Values.gateway.vpsE.proxyFqdn }}
        "{{ .Values.gateway.vpsE.proxyFqdn }}" ws_tls;
        {{- end }}
        {{- range (.Values.gateway.vpsE.entryMux.wsSniHosts | default (list)) }}
        "{{ . }}" ws_tls;
        {{- end }}
      }

      upstream reality {
        server 127.0.0.1:2443;
      }

      upstream ws_tls {
        server 127.0.0.1:4443;
      }

      server {
        listen 0.0.0.0:443;
        proxy_timeout 1h;
        proxy_connect_timeout 1s;
        proxy_pass $tg_upstream;
        ssl_preread on;
      }
    }

    http {
      server {
        listen 127.0.0.1:4443 ssl;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        location /healthz {
          return 200 "ok\n";
        }

        location {{ .Values.controlPlane.env.vlessWsPath | default "/ws" }} {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://127.0.0.1:10000;
        }

        location = / {
          default_type text/html;
          add_header Cache-Control "no-store" always;
          return 200 '<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Site Under Maintenance</title><style>body{font-family:Arial,sans-serif;background:#f4f6f8;color:#1f2937;margin:0;padding:24px;display:flex;min-height:100vh;align-items:center;justify-content:center}main{max-width:420px;width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,.08)}h1{font-size:22px;line-height:1.2;margin:0 0 10px}p{margin:0 0 18px;color:#4b5563}label{display:block;font-size:13px;margin:10px 0 6px}input{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px}button{width:100%;margin-top:14px;padding:10px 12px;border:0;border-radius:8px;background:#111827;color:#fff;cursor:not-allowed;opacity:.92}</style></head><body><main><h1>SITE UNDER MAINTENANCE</h1><p>Temporary login page placeholder.</p><form onsubmit="return false;"><label for="tg-login">Login</label><input id="tg-login" type="text" autocomplete="off" placeholder="Username"><label for="tg-password">Password</label><input id="tg-password" type="password" autocomplete="off" placeholder="Password"><button type="submit">Sign in</button></form></main></body></html>';
        }

        location / {
          default_type text/html;
          add_header Cache-Control "no-store" always;
          return 200 '<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Site Under Maintenance</title><style>body{font-family:Arial,sans-serif;background:#f4f6f8;color:#1f2937;margin:0;padding:24px;display:flex;min-height:100vh;align-items:center;justify-content:center}main{max-width:420px;width:100%;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;box-shadow:0 8px 24px rgba(0,0,0,.08)}h1{font-size:22px;line-height:1.2;margin:0 0 10px}p{margin:0 0 18px;color:#4b5563}label{display:block;font-size:13px;margin:10px 0 6px}input{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px}button{width:100%;margin-top:14px;padding:10px 12px;border:0;border-radius:8px;background:#111827;color:#fff;cursor:not-allowed;opacity:.92}</style></head><body><main><h1>SITE UNDER MAINTENANCE</h1><p>Temporary login page placeholder.</p><form onsubmit="return false;"><label for="tg-login">Login</label><input id="tg-login" type="text" autocomplete="off" placeholder="Username"><label for="tg-password">Password</label><input id="tg-password" type="password" autocomplete="off" placeholder="Password"><button type="submit">Sign in</button></form></main></body></html>';
        }
      }
    }
{{- end }}
{{- end }}

{{- $botGuideEnabled := and .Values.controlPlane.enabled (gt (int .Values.controlPlane.replicas.bot) 0) (.Values.controlPlane.botGuide.enabled | default false) (ne (.Values.controlPlane.botGuide.text | default "") "") }}
{{- if $botGuideEnabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-bot-guide
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  bot-guide.md: |
{{ .Values.controlPlane.botGuide.text | nindent 4 }}
{{- end }}
