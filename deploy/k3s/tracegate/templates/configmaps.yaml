{{- $realityGroups := (.Values.gateway.realityMultiInbound.groups | default (list)) -}}
{{- $transitDecoyHtml := (.Values.gateway.vpsT.decoyHtml | default "<!doctype html><html><head><meta charset=\"utf-8\"><title>Tracegate</title></head><body><h1>It works.</h1></body></html>") -}}
{{- $entryDecoyHtml := (.Values.gateway.entryDecoyHtml | default $transitDecoyHtml) -}}
{{- $failoverEnabled := and (.Values.gateway.failover.enabled | default false) .Values.gateway.vpsT.enabled .Values.gateway.vpsE.enabled -}}
{{- $failoverConnectTimeout := int (.Values.gateway.failover.connectTimeoutSeconds | default 1) -}}
{{- if lt $failoverConnectTimeout 1 }}{{- $failoverConnectTimeout = 1 -}}{{- end -}}
{{- $failoverMaxFails := int (.Values.gateway.failover.maxFails | default 2) -}}
{{- if lt $failoverMaxFails 1 }}{{- $failoverMaxFails = 1 -}}{{- end -}}
{{- $failoverFailTimeout := int (.Values.gateway.failover.failTimeoutSeconds | default 5) -}}
{{- if lt $failoverFailTimeout 1 }}{{- $failoverFailTimeout = 1 -}}{{- end -}}
{{- $vpsTPassiveHost := (.Values.gateway.failover.vpsTPassiveUpstreamHost | default "" | trim) -}}
{{- if and $failoverEnabled (eq $vpsTPassiveHost "") -}}
{{- $vpsTPassiveHost = (default .Values.gateway.vpsE.publicIPv4 (default .Values.gateway.vpsE.fqdn .Values.gateway.vpsE.proxyFqdn)) -}}
{{- end -}}
{{- $vpsEPassiveHost := (.Values.gateway.failover.vpsEPassiveUpstreamHost | default "" | trim) -}}
{{- if and $failoverEnabled (eq $vpsEPassiveHost "") -}}
{{- $vpsEPassiveHost = (default .Values.gateway.vpsT.publicIPv4 (default .Values.gateway.vpsT.fqdn .Values.gateway.vpsT.proxyFqdn)) -}}
{{- end -}}
{{- if and .Values.gateway.enabled (or .Values.gateway.vpsT.enabled .Values.gateway.vpsE.enabled) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-entry-decoy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  index.html: |
{{ $entryDecoyHtml | nindent 4 }}
{{- end }}
{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled }}
{{- $publicBaseUrl := (.Values.controlPlane.env.publicBaseUrl | default "" | trim) -}}
{{- $publicBaseHost := "" -}}
{{- if $publicBaseUrl -}}
{{- $publicBaseHost = regexReplaceAll "^https?://([^/:]+).*$" $publicBaseUrl "${1}" -}}
{{- end -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-decoy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  index.html: |
{{ $transitDecoyHtml | nindent 4 }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-entry-mux
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    stream {
      map $ssl_preread_server_name $tg_upstream {
        default reality_fallback;
        {{- range $group := $realityGroups }}
        {{- $gid := (toString ($group.id | default "")) -}}
        {{- if and $gid $group.port }}
        {{- $upstream := printf "reality_%s" (regexReplaceAll "[^a-zA-Z0-9_]" (replace "-" "_" (lower $gid)) "_") -}}
        {{- range ($group.snis | default (list)) }}
        "{{ . }}" {{ $upstream }};
        {{- end }}
        {{- end }}
        {{- end }}
        {{- if .Values.gateway.vpsT.fqdn }}
        "{{ .Values.gateway.vpsT.fqdn }}" ws_tls;
        {{- end }}
        {{- if and .Values.gateway.vpsT.proxyFqdn (ne .Values.gateway.vpsT.proxyFqdn .Values.gateway.vpsT.fqdn) }}
        "{{ .Values.gateway.vpsT.proxyFqdn }}" ws_tls;
        {{- end }}
        {{- if and $publicBaseHost (ne $publicBaseHost .Values.gateway.vpsT.fqdn) (or (not .Values.gateway.vpsT.proxyFqdn) (ne $publicBaseHost .Values.gateway.vpsT.proxyFqdn)) }}
        "{{ $publicBaseHost }}" ws_tls;
        {{- end }}
        {{- range (.Values.gateway.vpsT.entryMux.wsSniHosts | default (list)) }}
        "{{ . }}" ws_tls;
        {{- end }}
      }

      upstream reality_fallback {
        server 127.0.0.1:2443 max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- if and $failoverEnabled $vpsTPassiveHost }}
        server {{ $vpsTPassiveHost }}:443 backup max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- end }}
      }
      {{ range $group := $realityGroups }}
      {{ $gid := (toString ($group.id | default "")) }}
      {{ if and $gid $group.port }}
      {{ $upstream := printf "reality_%s" (regexReplaceAll "[^a-zA-Z0-9_]" (replace "-" "_" (lower $gid)) "_") }}
      upstream {{ $upstream }} {
        server 127.0.0.1:{{ int $group.port }} max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- if and $failoverEnabled $vpsTPassiveHost }}
        server {{ $vpsTPassiveHost }}:443 backup max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- end }}
      }
      {{ end }}
      {{ end }}

      upstream ws_tls {
        server 127.0.0.1:4443 max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- if and $failoverEnabled $vpsTPassiveHost }}
        server {{ $vpsTPassiveHost }}:443 backup max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- end }}
      }

      server {
        listen 0.0.0.0:443;
        proxy_timeout 1h;
        proxy_connect_timeout {{ $failoverConnectTimeout }}s;
        {{- if and $failoverEnabled $vpsTPassiveHost }}
        proxy_next_upstream on;
        proxy_next_upstream_tries 2;
        {{- end }}
        proxy_pass $tg_upstream;
        ssl_preread on;
      }
    }

    http {
      server {
        listen 127.0.0.1:4443 ssl;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        location /healthz {
          return 200 "ok\n";
        }

        location {{ .Values.controlPlane.env.vlessWsPath | default "/ws" }} {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://127.0.0.1:10000;
        }

        location = /grafana {
          return 302 /grafana/;
        }

        location ^~ /grafana/ {
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto https;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://{{ include "tracegate.fullname" . }}-api:{{ .Values.controlPlane.service.port }};
        }

        location = / {
          root /usr/share/nginx/html;
          index index.html;
          add_header Cache-Control "no-store" always;
          try_files /index.html =404;
        }

        location / {
          root /usr/share/nginx/html;
          index index.html;
          add_header Cache-Control "no-store" always;
          try_files /index.html =404;
        }
      }
    }
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled }}
{{- if eq .Values.gateway.vpsE.mode "tcpForward" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-haproxy
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  haproxy.cfg: |
    global
      maxconn 1000

    defaults
      mode tcp
      option tcplog
      timeout connect {{ $failoverConnectTimeout }}s
      timeout client  2m
      timeout server  2m

    frontend fe_443
      bind :443
      default_backend be_transit

    backend be_transit
      option tcp-check
      default-server inter 2s fall {{ $failoverMaxFails }} rise 1
      server transit_primary {{ .Values.gateway.vpsE.tcpForward.upstreamHost }}:{{ .Values.gateway.vpsE.tcpForward.upstreamPort }} check
      {{- if and $failoverEnabled $vpsEPassiveHost }}
      server transit_backup {{ $vpsEPassiveHost }}:443 check backup
      {{- end }}

    {{ $wsPort := int (.Values.controlPlane.env.vlessWsTlsPort | default 443) }}
    {{ if ne $wsPort 443 }}

    frontend fe_{{ $wsPort }}
      bind :{{ $wsPort }}
      default_backend be_ws_tls

    backend be_ws_tls
      option tcp-check
      default-server inter 2s fall {{ $failoverMaxFails }} rise 1
      server transit_ws_primary {{ .Values.gateway.vpsE.tcpForward.upstreamHost }}:{{ $wsPort }} check
      {{- if and $failoverEnabled $vpsEPassiveHost }}
      server transit_ws_backup {{ $vpsEPassiveHost }}:{{ $wsPort }} check backup
      {{- end }}
    {{ end }}
{{- end }}
{{- if eq .Values.gateway.vpsE.mode "xray" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-entry-mux
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  nginx.conf: |
    worker_processes  1;

    events {
      worker_connections  1024;
    }

    stream {
      map $ssl_preread_server_name $tg_upstream {
        default reality_fallback;
        {{- range $group := $realityGroups }}
        {{- $gid := (toString ($group.id | default "")) -}}
        {{- if and $gid $group.port }}
        {{- $upstream := printf "reality_%s" (regexReplaceAll "[^a-zA-Z0-9_]" (replace "-" "_" (lower $gid)) "_") -}}
        {{- range ($group.snis | default (list)) }}
        "{{ . }}" {{ $upstream }};
        {{- end }}
        {{- end }}
        {{- end }}
        {{- if .Values.gateway.vpsE.proxyFqdn }}
        "{{ .Values.gateway.vpsE.proxyFqdn }}" ws_tls;
        {{- end }}
        {{- range (.Values.gateway.vpsE.entryMux.wsSniHosts | default (list)) }}
        "{{ . }}" ws_tls;
        {{- end }}
      }

      upstream reality_fallback {
        server 127.0.0.1:2443 max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- if and $failoverEnabled $vpsEPassiveHost }}
        server {{ $vpsEPassiveHost }}:443 backup max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- end }}
      }
      {{ range $group := $realityGroups }}
      {{ $gid := (toString ($group.id | default "")) }}
      {{ if and $gid $group.port }}
      {{ $upstream := printf "reality_%s" (regexReplaceAll "[^a-zA-Z0-9_]" (replace "-" "_" (lower $gid)) "_") }}
      upstream {{ $upstream }} {
        server 127.0.0.1:{{ int $group.port }} max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- if and $failoverEnabled $vpsEPassiveHost }}
        server {{ $vpsEPassiveHost }}:443 backup max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- end }}
      }
      {{ end }}
      {{ end }}

      upstream ws_tls {
        server 127.0.0.1:4443 max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- if and $failoverEnabled $vpsEPassiveHost }}
        server {{ $vpsEPassiveHost }}:443 backup max_fails={{ $failoverMaxFails }} fail_timeout={{ $failoverFailTimeout }}s;
        {{- end }}
      }

      server {
        listen 0.0.0.0:443;
        proxy_timeout 1h;
        proxy_connect_timeout {{ $failoverConnectTimeout }}s;
        {{- if and $failoverEnabled $vpsEPassiveHost }}
        proxy_next_upstream on;
        proxy_next_upstream_tries 2;
        {{- end }}
        proxy_pass $tg_upstream;
        ssl_preread on;
      }
    }

    http {
      server {
        listen 127.0.0.1:4443 ssl;

        ssl_certificate     /etc/nginx/tls/tls.crt;
        ssl_certificate_key /etc/nginx/tls/tls.key;

        location /healthz {
          return 200 "ok\n";
        }

        location {{ .Values.controlPlane.env.vlessWsPath | default "/ws" }} {
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_set_header Host $host;
          proxy_read_timeout 1h;
          proxy_send_timeout 1h;
          proxy_pass http://127.0.0.1:10000;
        }

        location = / {
          root /usr/share/nginx/html;
          index index.html;
          add_header Cache-Control "no-store" always;
          try_files /index.html =404;
        }

        location / {
          root /usr/share/nginx/html;
          index index.html;
          add_header Cache-Control "no-store" always;
          try_files /index.html =404;
        }
      }
    }
{{- end }}
{{- end }}

{{- $botGuideEnabled := and .Values.controlPlane.enabled (gt (int .Values.controlPlane.replicas.bot) 0) (.Values.controlPlane.botGuide.enabled | default false) (ne (.Values.controlPlane.botGuide.text | default "") "") }}
{{- if $botGuideEnabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tracegate.fullname" . }}-bot-guide
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
data:
  bot-guide.md: |
{{ .Values.controlPlane.botGuide.text | nindent 4 }}
{{- end }}
