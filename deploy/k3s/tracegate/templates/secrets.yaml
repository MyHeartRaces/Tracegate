{{- if .Values.controlPlane.enabled }}
{{- $ns := include "tracegate.namespace" . -}}
{{- $authName := printf "%s-control-plane-auth" (include "tracegate.fullname" .) -}}
{{- $authExisting := lookup "v1" "Secret" $ns $authName -}}
{{- $whEnabled := and (gt (int .Values.controlPlane.replicas.bot) 0) .Values.controlPlane.botWebhook.enabled -}}
{{- $botEnabled := gt (int .Values.controlPlane.replicas.bot) 0 -}}
{{- $whPath := .Values.controlPlane.botWebhook.path -}}
{{- $whSecret := .Values.controlPlane.botWebhook.secretToken -}}
{{- $grafanaName := printf "%s-grafana-auth" (include "tracegate.fullname" .) -}}
{{- $grafanaExisting := lookup "v1" "Secret" $ns $grafanaName -}}
{{- $grafanaAdmin := .Values.observability.grafana.adminPassword -}}
{{- $grafanaCookie := "" -}}
{{- if $whEnabled -}}
  {{- if and (not $whPath) $authExisting (hasKey $authExisting.data "bot-webhook-path") -}}
    {{- $whPath = (b64dec (index $authExisting.data "bot-webhook-path")) -}}
  {{- end -}}
  {{- if and (not $whSecret) $authExisting (hasKey $authExisting.data "bot-webhook-secret-token") -}}
    {{- $whSecret = (b64dec (index $authExisting.data "bot-webhook-secret-token")) -}}
  {{- end -}}
  {{- if not $whPath -}}
    {{- $whPath = printf "/tg/%s" (randAlphaNum 32) -}}
  {{- end -}}
  {{- if not $whSecret -}}
    {{- $whSecret = randAlphaNum 32 -}}
  {{- end -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $authName }}
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  api-internal-token: {{ required "controlPlane.auth.apiInternalToken is required" .Values.controlPlane.auth.apiInternalToken | quote }}
  agent-auth-token: {{ required "controlPlane.auth.agentAuthToken is required" .Values.controlPlane.auth.agentAuthToken | quote }}
  bot-token: {{ if $botEnabled }}{{ required "controlPlane.auth.botToken is required when replicas.bot>0" .Values.controlPlane.auth.botToken | quote }}{{ else }}{{ .Values.controlPlane.auth.botToken | quote }}{{ end }}
{{ if $whEnabled }}
  bot-webhook-path: {{ $whPath | quote }}
  bot-webhook-secret-token: {{ $whSecret | quote }}
{{ end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $grafanaName }}
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{ if and (not $grafanaAdmin) $grafanaExisting (hasKey $grafanaExisting.data "admin-password") }}
  admin-password: {{ b64dec (index $grafanaExisting.data "admin-password") | quote }}
  {{ else if $grafanaAdmin }}
  admin-password: {{ $grafanaAdmin | quote }}
  {{ else }}
  admin-password: {{ randAlphaNum 32 | quote }}
  {{ end }}

  {{ if and $grafanaExisting (hasKey $grafanaExisting.data "cookie-secret") }}
  cookie-secret: {{ b64dec (index $grafanaExisting.data "cookie-secret") | quote }}
  {{ else }}
  cookie-secret: {{ randAlphaNum 64 | quote }}
  {{ end }}

{{- if .Values.controlPlane.postgres.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-postgres
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  postgres-password: {{ required "controlPlane.postgres.password is required" .Values.controlPlane.postgres.password | quote }}
{{- end }}

{{ if $whEnabled }}
{{- $tlsName := printf "%s-bot-webhook-tls" (include "tracegate.fullname" .) }}
{{- $tlsExisting := lookup "v1" "Secret" $ns $tlsName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $tlsName }}
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
{{ if and $tlsExisting (hasKey $tlsExisting.data "tls.crt") (hasKey $tlsExisting.data "tls.key") }}
  tls.crt: {{ index $tlsExisting.data "tls.crt" | quote }}
  tls.key: {{ index $tlsExisting.data "tls.key" | quote }}
{{ else }}
  {{- $host := required "controlPlane.botWebhook.publicHost is required when botWebhook.enabled=true" .Values.controlPlane.botWebhook.publicHost }}
  {{- $cert := genSelfSignedCert $host nil nil 3650 }}
  tls.crt: {{ $cert.Cert | b64enc | quote }}
  tls.key: {{ $cert.Key | b64enc | quote }}
{{ end }}
{{ end }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled .Values.gateway.vpsT.agent.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-agent-auth
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  agent-auth-token: {{ required "gateway.vpsT.agent.authToken is required" .Values.gateway.vpsT.agent.authToken | quote }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-xray-config
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  config.json: |
{{ tpl .Values.gateway.vpsT.xray.config . | nindent 4 }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-hysteria-config
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  config.yaml: |
{{ .Values.gateway.vpsT.hysteria.config | nindent 4 }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-wireguard-config
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  wg0.conf: |
{{ .Values.gateway.vpsT.wireguard.config | nindent 4 }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled .Values.gateway.vpsT.hysteriaTls.crt .Values.gateway.vpsT.hysteriaTls.key }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-hysteria-tls
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: kubernetes.io/tls
stringData:
  tls.crt: |
{{ .Values.gateway.vpsT.hysteriaTls.crt | nindent 4 }}
  tls.key: |
{{ .Values.gateway.vpsT.hysteriaTls.key | nindent 4 }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled (eq .Values.gateway.vpsE.mode "xray") }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-xray-config
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  config.json: |
{{ tpl .Values.gateway.vpsE.xray.config . | nindent 4 }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled (eq .Values.gateway.vpsE.mode "xray") }}
{{- $ns := include "tracegate.namespace" . -}}
{{- $tlsName := printf "%s-vps-e-ws-tls" (include "tracegate.fullname" .) -}}
{{- $tlsExisting := lookup "v1" "Secret" $ns $tlsName -}}
{{- if or (and .Values.gateway.vpsE.wsTls.crt (not .Values.gateway.vpsE.wsTls.key)) (and .Values.gateway.vpsE.wsTls.key (not .Values.gateway.vpsE.wsTls.crt)) -}}
{{- fail "gateway.vpsE.wsTls requires both crt and key (PEM)" -}}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $tlsName }}
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
{{ if and .Values.gateway.vpsE.wsTls.crt .Values.gateway.vpsE.wsTls.key }}
  tls.crt: {{ .Values.gateway.vpsE.wsTls.crt | b64enc | quote }}
  tls.key: {{ .Values.gateway.vpsE.wsTls.key | b64enc | quote }}
{{- else if and $tlsExisting (hasKey $tlsExisting.data "tls.crt") (hasKey $tlsExisting.data "tls.key") }}
  tls.crt: {{ index $tlsExisting.data "tls.crt" | quote }}
  tls.key: {{ index $tlsExisting.data "tls.key" | quote }}
{{- else }}
  {{- $host := (.Values.gateway.vpsE.proxyFqdn | default .Values.gateway.vpsE.fqdn) }}
  {{- if not $host }}{{- $host = "localhost" -}}{{- end }}
  {{- $cert := genSelfSignedCert $host nil nil 3650 }}
  tls.crt: {{ $cert.Cert | b64enc | quote }}
  tls.key: {{ $cert.Key | b64enc | quote }}
{{- end }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled .Values.gateway.vpsE.agent.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-agent-auth
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  agent-auth-token: {{ required "gateway.vpsE.agent.authToken is required" .Values.gateway.vpsE.agent.authToken | quote }}
{{- end }}
