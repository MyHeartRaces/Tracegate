{{- if .Values.controlPlane.enabled }}
{{- $ns := include "tracegate.namespace" . -}}
{{- $authName := printf "%s-control-plane-auth" (include "tracegate.fullname" .) -}}
{{- $authExisting := lookup "v1" "Secret" $ns $authName -}}
{{- $whEnabled := and (gt (int .Values.controlPlane.replicas.bot) 0) .Values.controlPlane.botWebhook.enabled -}}
{{- $whPath := .Values.controlPlane.botWebhook.path -}}
{{- $whSecret := .Values.controlPlane.botWebhook.secretToken -}}
{{- if $whEnabled -}}
  {{- if and (not $whPath) $authExisting (hasKey $authExisting.data "bot-webhook-path") -}}
    {{- $whPath = (b64dec (index $authExisting.data "bot-webhook-path")) -}}
  {{- end -}}
  {{- if and (not $whSecret) $authExisting (hasKey $authExisting.data "bot-webhook-secret-token") -}}
    {{- $whSecret = (b64dec (index $authExisting.data "bot-webhook-secret-token")) -}}
  {{- end -}}
  {{- if not $whPath -}}
    {{- $whPath = printf "/tg/%s" (randAlphaNum 32) -}}
  {{- end -}}
  {{- if not $whSecret -}}
    {{- $whSecret = randAlphaNum 32 -}}
  {{- end -}}
{{- end -}}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $authName }}
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  api-internal-token: {{ .Values.controlPlane.auth.apiInternalToken | quote }}
  agent-auth-token: {{ .Values.controlPlane.auth.agentAuthToken | quote }}
  bot-token: {{ .Values.controlPlane.auth.botToken | quote }}
{{ if $whEnabled }}
  bot-webhook-path: {{ $whPath | quote }}
  bot-webhook-secret-token: {{ $whSecret | quote }}
{{ end }}

{{- if .Values.controlPlane.postgres.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-postgres
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  postgres-password: {{ .Values.controlPlane.postgres.password | quote }}
{{- end }}

{{ if $whEnabled }}
{{- $tlsName := printf "%s-bot-webhook-tls" (include "tracegate.fullname" .) }}
{{- $tlsExisting := lookup "v1" "Secret" $ns $tlsName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $tlsName }}
  namespace: {{ $ns }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
{{ if and $tlsExisting (hasKey $tlsExisting.data "tls.crt") (hasKey $tlsExisting.data "tls.key") }}
  tls.crt: {{ index $tlsExisting.data "tls.crt" | quote }}
  tls.key: {{ index $tlsExisting.data "tls.key" | quote }}
{{ else }}
  {{- $host := required "controlPlane.botWebhook.publicHost is required when botWebhook.enabled=true" .Values.controlPlane.botWebhook.publicHost }}
  {{- $cert := genSelfSignedCert $host nil nil 3650 }}
  tls.crt: {{ $cert.Cert | b64enc | quote }}
  tls.key: {{ $cert.Key | b64enc | quote }}
{{ end }}
{{ end }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled .Values.gateway.vpsT.agent.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-agent-auth
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  agent-auth-token: {{ .Values.gateway.vpsT.agent.authToken | quote }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsT.enabled .Values.gateway.vpsT.hysteriaTls.crt .Values.gateway.vpsT.hysteriaTls.key }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-t-hysteria-tls
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: kubernetes.io/tls
stringData:
  tls.crt: |
{{ .Values.gateway.vpsT.hysteriaTls.crt | nindent 4 }}
  tls.key: |
{{ .Values.gateway.vpsT.hysteriaTls.key | nindent 4 }}
{{- end }}

{{- if and .Values.gateway.enabled .Values.gateway.vpsE.enabled .Values.gateway.vpsE.agent.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "tracegate.fullname" . }}-vps-e-agent-auth
  namespace: {{ include "tracegate.namespace" . }}
  labels:
    {{- include "tracegate.labels" . | nindent 4 }}
type: Opaque
stringData:
  agent-auth-token: {{ .Values.gateway.vpsE.agent.authToken | quote }}
{{- end }}
