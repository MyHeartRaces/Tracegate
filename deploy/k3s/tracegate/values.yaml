namespace:
  name: tracegate

imagePullSecrets: []

controlPlane:
  enabled: true
  image:
    repository: ghcr.io/your-org/tracegate
    tag: "0.2.0"
    pullPolicy: IfNotPresent

  replicas:
    api: 1
    dispatcher: 1
    bot: 0

  service:
    type: ClusterIP
    port: 8080

  postgres:
    enabled: true
    image: postgres:16
    username: tracegate
    # Secret (provide via values override / .env-based deploy flow; never commit real value to git)
    password: ""
    database: tracegate
    storage: 10Gi
    storageClassName: ""

  externalDatabaseUrl: ""

  auth:
    # Secrets (provide via values override / .env-based deploy flow; never commit real values to git)
    apiInternalToken: ""
    agentAuthToken: ""
    botToken: ""

  # Telegram bot webhook mode avoids polling conflicts. It uses HTTPS on port 8443
  # (Telegram allows 8443) so it does not conflict with Xray/Hysteria on 443.
  botWebhook:
    enabled: false
    publicHost: ""     # e.g. t.example.com
    publicPort: 8443
    listenHost: 0.0.0.0
    listenPort: 8443
    # path/secretToken are generated and persisted as k8s secrets unless explicitly set.
    path: ""
    secretToken: ""
    uploadCert: true

  env:
    appEnv: prod
    logLevel: INFO
    publicBaseUrl: ""
    defaultVpsTHost: vps-t.example.com
    defaultVpsEHost: vps-e.example.com
    realityPublicKey: ""
    realityShortId: ""
    wireguardServerPublicKey: ""
    vlessWsPath: /ws
    vlessWsTlsPort: 443
    grafana:
      enabled: false
      otpTtlSeconds: 300
      sessionTtlSeconds: 3600

  nodeSelector: {}
  tolerations: []
  affinity: {}

  resources:
    api: {}
    dispatcher: {}
    bot: {}
    postgres: {}

gateway:
  enabled: true

  agentImage:
    repository: ghcr.io/your-org/tracegate
    tag: "0.2.0"
    pullPolicy: IfNotPresent

  vpsT:
    enabled: true
    nodeSelector:
      tracegate.role: vps-t
    tolerations: []
    affinity: {}

    publicIPv4: 198.51.100.10
    fqdn: vps-t.example.com
    # Optional: a hostname expected to be proxied (e.g. Cloudflare orange cloud).
    # Use this for VLESS+WS+TLS if you want clients to connect via a proxied domain,
    # while keeping Reality/Hysteria on the direct fqdn/ip (DNS-only).
    proxyFqdn: ""

    hostNetwork: true
    shareProcessNamespace: true

    xray:
      image: ghcr.io/xtls/xray-core:latest
      pullPolicy: IfNotPresent
      config: |
        {
          "log": {"loglevel": "warning"},
          "inbounds": [
            {
              "tag": "vless-reality-in",
              "listen": "0.0.0.0",
              "port": 443,
              "protocol": "vless",
              "settings": {"clients": [], "decryption": "none"},
              "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "www.cloudflare.com:443",
                  "xver": 0,
                  "serverNames": ["google.com", "microsoft.com", "yandex.ru", "twitch.tv"],
                  "privateKey": "REPLACE_PRIVATE_KEY",
                  "shortIds": ["0123456789abcdef"]
                }
              }
            }
          ],
          "outbounds": [{"protocol": "freedom", "tag": "direct"}]
        }

    hysteria:
      image: tobyxdd/hysteria:v2
      pullPolicy: IfNotPresent
      config: |
        listen: :443
        acme:
          domains:
            - example.com
          email: admin@example.com
        auth:
          type: userpass
          userpass:
            bootstrap: bootstrap-password
        masquerade:
          type: file
          file:
            dir: /var/www/decoy
        trafficStats:
          listen: 127.0.0.1:9999
          secret: CHANGE_ME_HYSTERIA_STATS

    wireguard:
      image: ghcr.io/your-org/tracegate-wireguard:0.2.0
      pullPolicy: IfNotPresent
      interface: wg0
      config: |
        [Interface]
        Address = 10.70.0.1/24
        ListenPort = 51820
        PrivateKey = REPLACE_WG_PRIVATE_KEY
        SaveConfig = false

    decoyHtml: |
      <!doctype html>
      <html><head><meta charset="utf-8"><title>Tracegate</title></head><body><h1>It works.</h1></body></html>

    hysteriaTls:
      crt: ""
      key: ""

    agent:
      enabled: true
      host: 0.0.0.0
      port: 8070
      role: VPS_T
      authToken: ""
      dataRoot: /var/lib/tracegate-agent
      dryRun: false
      runtimeMode: kubernetes
      statsUrl: http://127.0.0.1:9999/traffic
      statsSecret: ""
      wgInterface: wg0
      wgExpectedPort: 51820
      # In k8s we restart the sidecar processes to pick up config changes.
      reloadXrayCmd: pkill -TERM xray || true
      reloadHysteriaCmd: pkill -TERM hysteria || true
      # Apply wg-quick config by stripping it to wg format and syncing live interface.
      reloadWgCmd: wg-quick strip /etc/wireguard/wg0.conf | wg syncconf wg0 /dev/fd/0 || true

    agentDataHostPath: /var/lib/tracegate-agent

  vpsE:
    enabled: true
    nodeSelector:
      tracegate.role: vps-e
    tolerations: []
    affinity: {}

    publicIPv4: 198.51.100.20
    fqdn: vps-e.example.com
    proxyFqdn: ""

    hostNetwork: true
    shareProcessNamespace: true

    # "tcpForward" is the default v0.1 chain implementation: L4 forward :443 -> VPS-T:443.
    # It preserves the client's REALITY SNI end-to-end and avoids any user mapping on VPS-E.
    mode: tcpForward
    tcpForward:
      image: haproxy:2.9-alpine
      pullPolicy: IfNotPresent
      upstreamHost: vps-t.example.com
      upstreamPort: 443

    xray:
      image: ghcr.io/xtls/xray-core:latest
      pullPolicy: IfNotPresent
      config: |
        {
          "log": {"loglevel": "warning"},
          "inbounds": [
            {
              "tag": "entry-in",
              "listen": "0.0.0.0",
              "port": 443,
              "protocol": "vless",
              "settings": {"clients": [], "decryption": "none"},
              "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "vps-t.example.com:443",
                  "xver": 0,
                  "serverNames": ["google.com", "microsoft.com", "yandex.ru", "twitch.tv"],
                  "privateKey": "REPLACE_PRIVATE_KEY",
                  "shortIds": ["fedcba9876543210"]
                }
              }
            }
          ],
          "outbounds": [
            {
              "tag": "to-transit",
              "protocol": "freedom"
            }
          ]
        }

    agent:
      enabled: true
      host: 0.0.0.0
      port: 8070
      role: VPS_E
      authToken: ""
      dataRoot: /var/lib/tracegate-agent
      dryRun: false
      runtimeMode: kubernetes
      statsUrl: http://127.0.0.1:9999/traffic
      statsSecret: ""
      wgInterface: wg0
      wgExpectedPort: 51820
      reloadXrayCmd: pkill -HUP xray || true
      reloadHysteriaCmd: ""
      reloadWgCmd: ""

    agentDataHostPath: /var/lib/tracegate-agent

registration:
  enabled: true
  hook: true
  retrySeconds: 60

observability:
  enabled: false

  prometheus:
    image: prom/prometheus:v2.52.0
    pullPolicy: IfNotPresent
    scrapeInterval: 15s
    storage:
      enabled: false
      size: 10Gi
      storageClassName: ""

  grafana:
    image: grafana/grafana:11.2.0
    pullPolicy: IfNotPresent
    # Secret; provide via values override.
    adminPassword: ""
    resources: {}

  nodeExporter:
    enabled: true
    image: prom/node-exporter:v1.8.1
    pullPolicy: IfNotPresent

  cadvisor:
    enabled: true
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    pullPolicy: IfNotPresent
