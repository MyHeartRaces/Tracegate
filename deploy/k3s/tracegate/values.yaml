namespace:
  name: tracegate

imagePullSecrets: []

controlPlane:
  enabled: true
  image:
    repository: ghcr.io/your-org/tracegate
    tag: "0.5"
    pullPolicy: IfNotPresent

  replicas:
    api: 1
    dispatcher: 1
    bot: 0

  dispatcherMetrics:
    enabled: true
    host: 0.0.0.0
    port: 9091

  botMetrics:
    enabled: true
    host: 0.0.0.0
    port: 9092

  dispatcherOps:
    alerts:
      enabled: false
      pollSeconds: 60
      repeatSeconds: 1800
      sendResolved: true
      suppressInitial: true
      httpTimeoutSeconds: 5
      prometheusUrl: http://tracegate-prometheus:9090
      gatewayRestarts: true
      disk:
        enabled: true
        thresholdPercent: 80
      outboxDead:
        enabled: true
        threshold: 0
      metricsServer:
        enabled: true
        maxAgeSeconds: 180
      nodeDown: true
      componentHealth: true

    outboxRetention:
      enabled: true
      intervalSeconds: 3600
      sentDays: 14
      failedDays: 30
      batchSize: 500
      maxBatchesPerRun: 20

  service:
    type: ClusterIP
    port: 8080

  postgres:
    enabled: true
    image: postgres:16
    username: tracegate
    # Secret (provide via values override / .env-based deploy flow; never commit real value to git)
    password: ""
    database: tracegate
    storage: 10Gi
    storageClassName: ""

  externalDatabaseUrl: ""

  auth:
    # Secrets (provide via values override / .env-based deploy flow; never commit real values to git)
    apiInternalToken: ""
    agentAuthToken: ""
    botToken: ""
    grafanaAlertsWebhookToken: ""

  # Telegram bot webhook mode avoids polling conflicts. It uses HTTPS on port 8443
  # (Telegram allows 8443) so it does not conflict with Xray/Hysteria on 443.
  botWebhook:
    enabled: false
    publicHost: ""     # e.g. t.example.com
    publicPort: 8443
    listenHost: 0.0.0.0
    listenPort: 8443
    # path/secretToken are generated and persisted as k8s secrets unless explicitly set.
    path: ""
    secretToken: ""
    uploadCert: true

  # /guide text can be overridden without touching DB by mounting it from a ConfigMap.
  # If disabled or text is empty, bot uses bundled default: bundles/bot/guide.md
  botGuide:
    enabled: false
    text: ""

  env:
    appEnv: prod
    logLevel: INFO
    publicBaseUrl: ""
    # JSON list, e.g. [123456789]. Used only to bootstrap role=superadmin on first user creation.
    superadminTelegramIds: []
    defaultVpsTHost: vps-t.example.com
    defaultVpsEHost: vps-e.example.com
    # Legacy REALITY material used as a fallback when per-role keys below are not set.
    realityPublicKey: ""
    realityShortId: ""
    # Optional per-role REALITY material. Required when B1 (direct to VPS-T) and B2 (chain via VPS-E)
    # terminate REALITY on different nodes with different keys/shortIds.
    realityPublicKeyVpsT: ""
    realityShortIdVpsT: ""
    realityPublicKeyVpsE: ""
    realityShortIdVpsE: ""
    wireguardServerPublicKey: ""
    vlessWsPath: /ws
    vlessWsTlsPort: 443
    grafana:
      enabled: false
      otpTtlSeconds: 300
      sessionTtlSeconds: 3600

  nodeSelector: {}
  tolerations: []
  affinity: {}
  terminationGracePeriodSeconds: 30
  pdb:
    enabled: true

  resources:
    api: {}
    dispatcher: {}
    bot: {}
    postgres: {}

gateway:
  enabled: true

  agentImage:
    repository: ghcr.io/your-org/tracegate
    tag: "0.5"
    pullPolicy: IfNotPresent

  splitter:
    transit:
      # Must match VPS-T static transit client id in Xray.
      uuid: "00000000-0000-4000-8000-000000000123"
      # If empty, falls back to controlPlane.env.realityPublicKey.
      publicKey: ""
      shortId: "0123456789abcdef"
      serverName: "splitter.wb.ru"
      upstreamHost: "vps-t.example.com"
      upstreamPort: 443

  # REALITY multi-inbound groups.
  # One external port remains fixed (:443), entry-mux routes by SNI to local Xray ports.
  # Keep this list aligned with static SNI catalog used by the bot/API.
  realityMultiInbound:
    groups:
      - id: shared-a
        port: 2501
        dest: splitter.wb.ru
        snis: ["splitter.wb.ru"]
      - id: shared-b
        port: 2502
        dest: st.ozone.ru
        snis: ["st.ozone.ru"]
      - id: shared-c
        port: 2503
        dest: speller.yandex.net
        snis: ["speller.yandex.net"]
      - id: mts-a
        port: 2504
        dest: a.wb.ru
        snis: ["a.wb.ru"]
      - id: mts-b
        port: 2505
        dest: alfabank.ru
        snis: ["alfabank.ru"]
      - id: megafon-a
        port: 2506
        dest: dzen.ru
        snis: ["dzen.ru"]
      - id: megafon-b
        port: 2507
        dest: ok.ru
        snis: ["ok.ru"]
      - id: t2-a
        port: 2508
        dest: yandex.ru
        snis: ["yandex.ru"]
      - id: t2-b
        port: 2509
        dest: sba.yandex.net
        snis: ["sba.yandex.net"]
      - id: tmobile-a
        port: 2510
        dest: login.vk.com
        snis: ["login.vk.com"]
      - id: tmobile-b
        port: 2511
        dest: goya.rutube.ru
        snis: ["goya.rutube.ru"]
      - id: rtk-a
        port: 2512
        dest: vk.com
        snis: ["vk.com"]
      - id: rtk-b
        port: 2513
        dest: www.wildberries.ru
        snis: ["www.wildberries.ru"]
      - id: yota-a
        port: 2514
        dest: queuev4.vk.com
        snis: ["queuev4.vk.com"]
      - id: yota-b
        port: 2515
        dest: www.kinopoisk.ru
        snis: ["www.kinopoisk.ru"]

  entryDecoyHtml: |
    <!doctype html>
    <html lang="ru">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta name="theme-color" content="#065f46">
      <title>Единая точка входа</title>
      <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23065f46'/%3E%3Ctext x='32' y='43' text-anchor='middle' fill='white' font-size='34' font-family='Arial,sans-serif'%3EE%3C/text%3E%3C/svg%3E">
      <style>
        :root{color-scheme:light;--bg:#eef7f4;--ink:#10231d;--muted:#4f635d;--line:#d2e4dd;--card:rgba(255,255,255,.9);--accent:#0f766e;--accent2:#065f46}
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
          margin:0;
          font-family:"IBM Plex Sans","Segoe UI",Tahoma,sans-serif;
          color:var(--ink);
          background:
            radial-gradient(circle at 10% 10%, rgba(15,118,110,.13), transparent 38%),
            radial-gradient(circle at 90% 18%, rgba(6,95,70,.11), transparent 42%),
            linear-gradient(180deg, #eaf4f1, #f7fbfa);
        }
        .layout{width:min(1080px,94vw);margin:20px auto;display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
        .card{background:var(--card);border:1px solid rgba(210,228,221,.95);border-radius:18px;box-shadow:0 18px 48px rgba(16,35,29,.06);backdrop-filter:blur(8px)}
        .hero{padding:20px;display:grid;gap:14px}
        .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
        .brand{display:inline-flex;align-items:center;gap:10px;font-weight:700}
        .mark{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;color:#fff;background:linear-gradient(135deg,#0f766e,#065f46);box-shadow:0 10px 24px rgba(6,95,70,.25)}
        .badge{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:7px 12px;border:1px solid rgba(15,118,110,.18);background:rgba(15,118,110,.08);font-size:12px;font-weight:600;color:#14532d}
        .dot{width:8px;height:8px;border-radius:999px;background:#16a34a;box-shadow:0 0 0 0 rgba(22,163,74,.36);animation:pulse 1.8s infinite}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(22,163,74,.36)}70%{box-shadow:0 0 0 10px rgba(22,163,74,0)}100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}}
        h1{margin:0;font-size:clamp(24px,4vw,34px);line-height:1.07;letter-spacing:-.02em}
        .lead{margin:0;color:var(--muted);line-height:1.55;max-width:56ch}
        .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
        .stat{border:1px solid var(--line);border-radius:13px;padding:11px;background:rgba(255,255,255,.72)}
        .stat b{display:block;font-size:17px;letter-spacing:-.02em}
        .stat span{display:block;margin-top:4px;font-size:12px;color:var(--muted)}
        .list{display:grid;gap:10px;padding:12px;border:1px solid var(--line);border-radius:13px;background:rgba(255,255,255,.72)}
        .list h2{margin:0;font-size:13px;text-transform:uppercase;letter-spacing:.03em;color:#334155}
        .row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:start}
        .row i{margin-top:5px;width:7px;height:7px;border-radius:999px;background:#0f766e;display:block}
        .row strong{display:block;font-size:13px}
        .row small{display:block;margin-top:2px;color:var(--muted);font-size:12px;line-height:1.35}
        .auth{padding:20px;display:grid;gap:14px;align-content:start}
        .auth h2{margin:0;font-size:23px;letter-spacing:-.02em}
        .auth p{margin:6px 0 0;color:var(--muted);line-height:1.45}
        form{display:grid;gap:10px}
        label{display:block;font-size:12px;font-weight:600;color:#334155}
        input,select{
          width:100%;height:44px;margin-top:6px;
          border:1px solid #c9ddd6;border-radius:12px;padding:0 12px;
          background:rgba(255,255,255,.95);font:inherit;color:var(--ink)
        }
        input:focus,select:focus{outline:2px solid rgba(15,118,110,.12);border-color:rgba(15,118,110,.35)}
        .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .inline{display:flex;justify-content:space-between;align-items:center;gap:10px}
        .check{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
        .check input{width:16px;height:16px;margin:0}
        a{color:var(--accent);text-decoration:none}
        button{
          height:46px;border:0;border-radius:12px;color:#fff;font-weight:700;cursor:pointer;
          background:linear-gradient(135deg,var(--accent),var(--accent2));
          box-shadow:0 12px 28px rgba(15,118,110,.22)
        }
        button:disabled{opacity:.75;cursor:wait}
        .foot{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line);padding-top:12px;color:var(--muted);font-size:12px}
        @media (max-width:920px){.layout{grid-template-columns:1fr}.stats{grid-template-columns:1fr 1fr}}
        @media (max-width:560px){.stats,.split{grid-template-columns:1fr}.hero,.auth{padding:16px}}
      </style>
    </head>
    <body>
      <div class="layout">
        <section class="card hero" aria-label="Информация о сервисе">
          <div class="top">
            <div class="brand"><div class="mark">E</div><span>Entry Gateway</span></div>
            <div class="badge"><span class="dot" aria-hidden="true"></span>Сервис доступен</div>
          </div>
          <div>
            <h1>Единая точка входа для защищенного доступа</h1>
            <p class="lead">Авторизуйтесь для перехода в кабинет. После входа автоматически выполняется проверка учетной записи и параметров рабочей среды.</p>
          </div>
          <div class="stats">
            <div class="stat"><b class="js-time">--:--:--</b><span>Локальное время</span></div>
            <div class="stat"><b>24/7</b><span>Круглосуточный доступ</span></div>
            <div class="stat"><b>2FA</b><span>Требуется для части аккаунтов</span></div>
          </div>
          <div class="list" aria-label="Системные уведомления">
            <h2>Уведомления</h2>
            <div class="row"><i aria-hidden="true"></i><div><strong>Плановые проверки активны</strong><small>Вход может занять немного больше времени в часы пиковой нагрузки.</small></div></div>
            <div class="row"><i aria-hidden="true"></i><div><strong>Поддержка пользователей</strong><small>Запросы в службу поддержки обрабатываются через личный кабинет после входа.</small></div></div>
            <div class="row"><i aria-hidden="true"></i><div><strong>Безопасность</strong><small>Рекомендуется использовать отдельный пароль для корпоративного доступа.</small></div></div>
          </div>
        </section>
        <aside class="card auth" aria-label="Форма входа">
          <div>
            <h2>Вход в кабинет</h2>
            <p>Введите данные учетной записи для продолжения работы.</p>
          </div>
          <form id="portal-login" autocomplete="off">
            <div>
              <label for="login-user">Логин</label>
              <input id="login-user" type="text" placeholder="Введите логин">
            </div>
            <div>
              <label for="login-pass">Пароль</label>
              <input id="login-pass" type="password" placeholder="Введите пароль">
            </div>
            <div class="split">
              <div>
                <label for="org-code">Код организации</label>
                <input id="org-code" type="text" placeholder="Например, RU-01">
              </div>
              <div>
                <label for="lang-select">Язык интерфейса</label>
                <select id="lang-select">
                  <option>Русский</option>
                  <option>English</option>
                </select>
              </div>
            </div>
            <div class="inline">
              <label class="check"><input type="checkbox" checked>Запомнить устройство</label>
              <a href="/password/reset">Восстановить доступ</a>
            </div>
            <button id="submit-btn" type="submit">Продолжить</button>
          </form>
          <div class="foot">
            <span>Единый шлюз доступа</span>
            <span><a href="/help">Помощь</a> · <a href="/status">Статус</a> · <a href="/support">Поддержка</a></span>
          </div>
        </aside>
      </div>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var timeEl = document.querySelector(".js-time");
          var form = document.getElementById("portal-login");
          var submit = document.getElementById("submit-btn");
          function updateClock() {
            if (!timeEl) return;
            timeEl.textContent = new Date().toLocaleTimeString("ru-RU", { hour12: false });
          }
          updateClock();
          setInterval(updateClock, 1000);
          if (!form) return;
          form.addEventListener("submit", function (event) {
            event.preventDefault();
            if (submit) {
              submit.disabled = true;
              submit.textContent = "Проверка...";
            }
            setTimeout(function () {
              window.location.href = "/dashboard";
            }, 650);
          });
        });
      </script>
    </body>
    </html>

  vpsT:
    enabled: true
    nodeSelector:
      tracegate.role: vps-t
    tolerations: []
    affinity: {}

    publicIPv4: 198.51.100.10
    fqdn: vps-t.example.com
    # Optional: a hostname expected to be proxied (e.g. Cloudflare orange cloud).
    # Use this for VLESS+WS+TLS if you want clients to connect via a proxied domain,
    # while keeping Reality/Hysteria on the direct fqdn/ip (DNS-only).
    proxyFqdn: ""

    hostNetwork: true
    shareProcessNamespace: true

    entryMux:
      image: nginx:1.24-alpine
      pullPolicy: IfNotPresent
      # Optional extra SNI hostnames that should be treated as VLESS+WS+TLS.
      wsSniHosts: []

    # TLS certificate used to terminate VLESS+WS+TLS on VPS-T.
    # Leave empty to generate and persist a self-signed cert in a k8s Secret.
    wsTls:
      crt: ""
      key: ""

    xray:
      image: ghcr.io/xtls/xray-core:latest
      pullPolicy: IfNotPresent
      config: |
        {
          "log": {"loglevel": "warning"},
          "api": {"tag":"api","services":["HandlerService","StatsService"]},
          "stats": {},
          "policy": {
            "levels": {
              "0": {
                "statsUserUplink": true,
                "statsUserDownlink": true
              }
            },
            "system": {
              "statsInboundUplink": true,
              "statsInboundDownlink": true,
              "statsOutboundUplink": true,
              "statsOutboundDownlink": true
            }
          },
          "inbounds": [
            {
              "tag": "api",
              "listen": "127.0.0.1",
              "port": 8080,
              "protocol": "dokodemo-door",
              "settings": {"address": "127.0.0.1"}
            },
            {
              "tag": "vless-reality-in",
              "listen": "127.0.0.1",
              "port": 2443,
              "protocol": "vless",
              "settings": {
                "clients": [
                  {
                    "id": "{{ .Values.gateway.splitter.transit.uuid }}",
                    "email": "vps-e-transit"
                  }
                ],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "xhttp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "splitter.wb.ru:443",
                  "xver": 0,
                  "serverNames": ["splitter.wb.ru"],
                  "privateKey": "REPLACE_PRIVATE_KEY",
                  "shortIds": ["0123456789abcdef"]
                },
                "xhttpSettings": {
                  "mode": "packet-up",
                  "path": "/api/v1/update"
                }
              }
            },
            {
              "tag": "vless-ws-in",
              "listen": "127.0.0.1",
              "port": 10000,
              "protocol": "vless",
              "settings": {
                "clients": [],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "ws",
                "security": "none",
                "wsSettings": {
                  "path": "{{ .Values.controlPlane.env.vlessWsPath | default "/ws" }}"
                }
              },
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            }
          ],
          "outbounds": [
            {"protocol": "freedom", "tag": "api"},
            {"protocol": "freedom", "tag": "direct"}
          ],
          "routing": {
            "rules": [
              {"type": "field", "inboundTag": ["api"], "outboundTag": "api"},
              {"type": "field", "inboundTag": ["vless-reality-in", "vless-ws-in"], "outboundTag": "direct"}
            ]
          }
        }

    hysteria:
      image: tobyxdd/hysteria:v2
      pullPolicy: IfNotPresent
      config: |
        listen: :443
        acme:
          domains:
            - example.com
          email: admin@example.com
        auth:
          type: userpass
          userpass:
            bootstrap: bootstrap-password
        masquerade:
          type: file
          file:
            dir: /var/www/decoy
        trafficStats:
          listen: 127.0.0.1:9999
          secret: CHANGE_ME_HYSTERIA_STATS

    wireguard:
      image: ghcr.io/your-org/tracegate-wireguard:0.5
      pullPolicy: IfNotPresent
      interface: wg0
      config: |
        [Interface]
        Address = 10.70.0.1/24
        ListenPort = 51820
        PrivateKey = REPLACE_WG_PRIVATE_KEY
        SaveConfig = false

    decoyHtml: |
      <!doctype html>
      <html lang="en">
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width,initial-scale=1" />
          <meta name="theme-color" content="#0f172a" />
          <title>Transit Workspace Portal</title>
          <link
            rel="icon"
            type="image/svg+xml"
            href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%230f172a'/%3E%3Ctext x='32' y='43' text-anchor='middle' fill='white' font-size='34' font-family='Arial,sans-serif'%3ET%3C/text%3E%3C/svg%3E"
          />
          <style>
            :root {
              color-scheme: light;
              --bg0: #e7edf6;
              --bg1: #f8fafc;
              --ink: #0f172a;
              --muted: #556274;
              --line: #d6deea;
              --card: rgba(255, 255, 255, 0.88);
              --accent: #0b6bcb;
              --accent-2: #0891b2;
              --ok: #0f9d58;
              --warn: #d97706;
            }
            * { box-sizing: border-box; }
            html, body { height: 100%; }
            body {
              margin: 0;
              font-family: "IBM Plex Sans", "Segoe UI", Tahoma, sans-serif;
              color: var(--ink);
              background:
                radial-gradient(circle at 12% 12%, rgba(11, 107, 203, 0.12), transparent 45%),
                radial-gradient(circle at 88% 14%, rgba(8, 145, 178, 0.14), transparent 40%),
                radial-gradient(circle at 50% 100%, rgba(15, 23, 42, 0.05), transparent 35%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
            }
            .shell { width: min(1120px, 94vw); margin: 28px auto; display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 18px; }
            .panel {
              background: var(--card);
              border: 1px solid rgba(214, 222, 234, 0.9);
              border-radius: 18px;
              box-shadow: 0 18px 60px rgba(15, 23, 42, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.8);
              backdrop-filter: blur(8px);
            }
            .hero { padding: 22px; display: grid; gap: 16px; }
            .bar { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
            .brand { display: inline-flex; align-items: center; gap: 10px; font-weight: 700; letter-spacing: 0.02em; }
            .brand-mark {
              width: 34px; height: 34px; border-radius: 10px; display: grid; place-items: center; color: #fff;
              background: linear-gradient(135deg, #0f172a, #1d4ed8); box-shadow: 0 8px 22px rgba(29, 78, 216, 0.28);
            }
            .status-pill {
              display: inline-flex; align-items: center; gap: 8px; border-radius: 999px; padding: 7px 12px;
              border: 1px solid rgba(15, 157, 88, 0.16); background: rgba(15, 157, 88, 0.08);
              color: #14532d; font-size: 12px; font-weight: 600;
            }
            .pulse {
              width: 8px; height: 8px; border-radius: 999px; background: var(--ok);
              box-shadow: 0 0 0 0 rgba(15, 157, 88, 0.38); animation: pulse 1.8s infinite;
            }
            @keyframes pulse {
              0% { box-shadow: 0 0 0 0 rgba(15, 157, 88, 0.38); }
              70% { box-shadow: 0 0 0 10px rgba(15, 157, 88, 0); }
              100% { box-shadow: 0 0 0 0 rgba(15, 157, 88, 0); }
            }
            h1 { margin: 0; font-size: clamp(26px, 4vw, 36px); line-height: 1.05; letter-spacing: -0.02em; }
            .lead { margin: 0; color: var(--muted); line-height: 1.55; max-width: 56ch; }
            .cards { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
            .stat { border-radius: 14px; border: 1px solid var(--line); background: rgba(255, 255, 255, 0.74); padding: 12px; }
            .stat-label { font-size: 12px; color: var(--muted); margin-bottom: 5px; }
            .stat-value { font-weight: 700; font-size: 18px; letter-spacing: -0.02em; }
            .subtle { font-size: 12px; color: var(--muted); }
            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .mini { border: 1px solid var(--line); border-radius: 14px; padding: 12px; background: rgba(255, 255, 255, 0.7); }
            .mini h2 { margin: 0 0 10px; font-size: 13px; letter-spacing: 0.02em; text-transform: uppercase; color: #334155; }
            .feed { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
            .feed li { display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: start; }
            .dot { margin-top: 6px; width: 7px; height: 7px; border-radius: 999px; background: var(--accent); }
            .dot.warn { background: var(--warn); }
            .dot.ok { background: var(--ok); }
            .row-title { font-size: 13px; font-weight: 600; }
            .row-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
            .auth { padding: 22px; display: grid; gap: 14px; align-content: start; }
            .auth-head h2 { margin: 0; font-size: 24px; letter-spacing: -0.02em; }
            .auth-head p { margin: 6px 0 0; color: var(--muted); line-height: 1.5; }
            form { display: grid; gap: 10px; }
            label { font-size: 12px; color: #334155; font-weight: 600; }
            input, select {
              width: 100%; height: 44px; border-radius: 12px; border: 1px solid #cdd7e5; background: rgba(255, 255, 255, 0.95);
              padding: 0 12px; font: inherit; color: var(--ink);
            }
            input:focus, select:focus { outline: 2px solid rgba(11, 107, 203, 0.14); border-color: rgba(11, 107, 203, 0.38); }
            .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .inline { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 2px; }
            .checkbox { display: inline-flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px; }
            .checkbox input { width: 16px; height: 16px; margin: 0; }
            .link { color: var(--accent); text-decoration: none; font-size: 13px; }
            .btn {
              border: 0; height: 46px; border-radius: 12px; color: #fff; background: linear-gradient(135deg, var(--accent), var(--accent-2));
              font-weight: 700; letter-spacing: 0.01em; cursor: pointer; box-shadow: 0 12px 28px rgba(8, 145, 178, 0.25);
            }
            .btn:disabled { opacity: 0.72; cursor: wait; }
            .footer {
              display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; color: var(--muted);
              font-size: 12px; border-top: 1px solid var(--line); padding-top: 12px;
            }
            .footer a { color: inherit; text-decoration: none; }
            .queue { font-variant-numeric: tabular-nums; }
            @media (max-width: 920px) { .shell { grid-template-columns: 1fr; margin: 14px auto 20px; } .cards { grid-template-columns: 1fr 1fr; } }
            @media (max-width: 560px) { .cards, .grid, .form-grid { grid-template-columns: 1fr; } .hero, .auth { padding: 16px; } }
          </style>
        </head>
        <body>
          <div class="shell">
            <section class="panel hero" aria-label="Transit portal overview">
              <div class="bar">
                <div class="brand"><div class="brand-mark">T</div><span>Transit Workspace</span></div>
                <div class="status-pill"><span class="pulse" aria-hidden="true"></span> Operational</div>
              </div>
              <div>
                <h1>Access gateway for managed transit workloads</h1>
                <p class="lead">Use your assigned workspace credentials to sign in and continue to the internal dashboard. Session verification and policy checks are performed automatically after login.</p>
              </div>
              <div class="cards" aria-label="Overview metrics">
                <div class="stat"><div class="stat-label">Availability</div><div class="stat-value">99.98%</div><div class="subtle">rolling 30-day window</div></div>
                <div class="stat"><div class="stat-label">Queue</div><div class="stat-value queue js-queue">12 sessions</div><div class="subtle">verification pending</div></div>
                <div class="stat"><div class="stat-label">Updated</div><div class="stat-value js-time">--:--:--</div><div class="subtle">local system time</div></div>
              </div>
              <div class="grid">
                <section class="mini" aria-label="Recent activity">
                  <h2>Operations Feed</h2>
                  <ul class="feed">
                    <li><span class="dot ok" aria-hidden="true"></span><div><div class="row-title">Transit health checks completed</div><div class="row-meta">No anomalies detected in the latest maintenance window.</div></div></li>
                    <li><span class="dot" aria-hidden="true"></span><div><div class="row-title">Policy cache refreshed</div><div class="row-meta">Workspace entitlements synchronized across active regions.</div></div></li>
                    <li><span class="dot warn" aria-hidden="true"></span><div><div class="row-title">Scheduled review in progress</div><div class="row-meta">Background validation tasks may increase sign-in time briefly.</div></div></li>
                  </ul>
                </section>
                <section class="mini" aria-label="Support details">
                  <h2>Support</h2>
                  <ul class="feed">
                    <li><span class="dot ok" aria-hidden="true"></span><div><div class="row-title">Primary desk</div><div class="row-meta">Mon-Fri 08:00-20:00 UTC</div></div></li>
                    <li><span class="dot" aria-hidden="true"></span><div><div class="row-title">Maintenance notices</div><div class="row-meta">Published in the dashboard status section after sign-in.</div></div></li>
                    <li><span class="dot" aria-hidden="true"></span><div><div class="row-title">Escalations</div><div class="row-meta">Use your assigned account representative contact channel.</div></div></li>
                  </ul>
                </section>
              </div>
            </section>
            <aside class="panel auth" aria-label="Sign-in form">
              <div class="auth-head">
                <h2>Member Sign In</h2>
                <p>Enter your account details to continue to the managed transit portal dashboard.</p>
              </div>
              <form id="portal-login" autocomplete="off">
                <div><label for="login-user">Username</label><input id="login-user" type="text" placeholder="username" /></div>
                <div><label for="login-pass">Password</label><input id="login-pass" type="password" placeholder="Password" /></div>
                <div class="form-grid">
                  <div><label for="workspace">Workspace</label><select id="workspace"><option>Transit - Primary</option><option>Transit - Backup</option><option>Shared Access</option></select></div>
                  <div><label for="region">Region</label><select id="region"><option>Auto</option><option>EU</option><option>APAC</option></select></div>
                </div>
                <div class="inline">
                  <label class="checkbox"><input type="checkbox" checked />Remember this device</label>
                  <a class="link" href="/password/reset">Reset password</a>
                </div>
                <button id="submit-btn" class="btn" type="submit">Continue to Dashboard</button>
              </form>
              <div class="footer">
                <span>v2 gateway interface</span>
                <span><a href="/status">Status</a> · <a href="/docs">Docs</a> · <a href="/support">Support</a></span>
              </div>
            </aside>
          </div>
          <script>
            document.addEventListener("DOMContentLoaded", function () {
              var timeEl = document.querySelector(".js-time");
              var queueEl = document.querySelector(".js-queue");
              var form = document.getElementById("portal-login");
              var submit = document.getElementById("submit-btn");
              var queueBase = 12;
              function renderClock() {
                var now = new Date();
                if (timeEl) timeEl.textContent = now.toLocaleTimeString("en-GB", { hour12: false });
                if (queueEl) queueEl.textContent = (queueBase + (now.getSeconds() % 5)) + " sessions";
              }
              renderClock();
              setInterval(renderClock, 1000);
              if (!form) return;
              form.addEventListener("submit", function (event) {
                event.preventDefault();
                if (submit) { submit.disabled = true; submit.textContent = "Verifying..."; }
                setTimeout(function () { window.location.href = "/dashboard"; }, 650);
              });
            });
          </script>
        </body>
      </html>

    hysteriaTls:
      crt: ""
      key: ""

    agent:
      enabled: true
      host: 0.0.0.0
      port: 8070
      role: VPS_T
      authToken: ""
      dataRoot: /var/lib/tracegate-agent
      dryRun: false
      runtimeMode: kubernetes
      # Enable Xray gRPC API mode to add/remove users without restarting Xray.
      xrayApiEnabled: false
      xrayApiServer: 127.0.0.1:8080
      xrayApiTimeoutSeconds: 3
      statsUrl: http://127.0.0.1:9999/traffic
      statsSecret: ""
      wgInterface: wg0
      wgExpectedPort: 51820
      # Coalesce burst events into a single xray reload and avoid CrashLoopBackOff.
      reloadXrayCmd: sh -lc '(flock 9; sleep 1; pkill -HUP xray || true) 9>/tmp/xray-reload.lock'
      # Keep empty by default: some Hysteria v2 builds exit on SIGHUP and trigger container restarts.
      reloadHysteriaCmd: ""
      # Apply wg-quick config by stripping it to wg format and syncing live interface.
      reloadWgCmd: wg-quick strip /etc/wireguard/wg0.conf | wg syncconf wg0 /dev/fd/0 || true

    agentDataHostPath: /var/lib/tracegate-agent

  vpsE:
    enabled: true
    nodeSelector:
      tracegate.role: vps-e
    tolerations: []
    affinity: {}

    publicIPv4: 198.51.100.20
    fqdn: vps-e.example.com
    proxyFqdn: ""

    hostNetwork: true
    shareProcessNamespace: true

    entryMux:
      image: nginx:1.24-alpine
      pullPolicy: IfNotPresent
      # Optional extra SNI hostnames that should be treated as VLESS+WS+TLS.
      # `proxyFqdn` is included automatically (if set).
      wsSniHosts: []

    # TLS certificate used to terminate VLESS+WS+TLS on VPS-E (chain mode / splitter).
    # Leave empty to generate and persist a self-signed cert in a k8s Secret.
    wsTls:
      crt: ""
      key: ""

    # Optional Hysteria2 entry on VPS-E (UDP/443) with backhaul via local Xray -> VPS-T REALITY transit.
    hysteria:
      enabled: true
      image: tobyxdd/hysteria:v2
      pullPolicy: IfNotPresent
      config: |
        listen: :443
        tls:
          cert: /etc/hysteria/tls/tls.crt
          key: /etc/hysteria/tls/tls.key
        auth:
          type: userpass
          userpass:
            bootstrap: bootstrap-password
        masquerade:
          type: file
          file:
            dir: /var/www/decoy
        outbounds:
          - name: xray_transit
            type: socks5
            socks5:
              addr: 127.0.0.1:1081

    # "tcpForward" is the legacy v0.1 chain implementation: L4 forward :443 -> VPS-T:443.
    # "xray" enables VPS-E user mapping and split-routing (RU/domestic via VPS-E, rest via VPS-T transit).
    mode: tcpForward
    tcpForward:
      image: haproxy:2.9-alpine
      pullPolicy: IfNotPresent
      upstreamHost: vps-t.example.com
      upstreamPort: 443

    xray:
      image: ghcr.io/xtls/xray-core:latest
      pullPolicy: IfNotPresent
      # Splitter mode uses gateway.splitter.transit.* values for VPS-E -> VPS-T transit.
      config: |
        {
          "log": {"loglevel": "warning"},
          "api": {"tag":"api","services":["HandlerService","StatsService"]},
          "stats": {},
          "policy": {
            "levels": {
              "0": {
                "statsUserUplink": true,
                "statsUserDownlink": true
              }
            },
            "system": {
              "statsInboundUplink": true,
              "statsInboundDownlink": true,
              "statsOutboundUplink": true,
              "statsOutboundDownlink": true
            }
          },
          "inbounds": [
            {
              "tag": "api",
              "listen": "127.0.0.1",
              "port": 8080,
              "protocol": "dokodemo-door",
              "settings": {"address": "127.0.0.1"}
            },
            {
              "tag": "entry-in",
              "listen": "127.0.0.1",
              "port": 2443,
              "protocol": "vless",
              "settings": {"clients": [], "decryption": "none"},
              "streamSettings": {
                "network": "xhttp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "splitter.wb.ru:443",
                  "xver": 0,
                  "serverNames": ["splitter.wb.ru"],
                  "privateKey": "REPLACE_PRIVATE_KEY",
                  "shortIds": ["fedcba9876543210"]
                },
                "xhttpSettings": {
                  "mode": "packet-up",
                  "path": "/api/v1/update"
                }
              },
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            },
            {
              "tag": "vless-ws-in",
              "listen": "127.0.0.1",
              "port": 10000,
              "protocol": "vless",
              "settings": {"clients": [], "decryption": "none"},
              "streamSettings": {
                "network": "ws",
                "security": "none",
                "wsSettings": {
                  "path": "{{ .Values.controlPlane.env.vlessWsPath | default "/ws" }}"
                }
              },
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            },
            {
              "tag": "hy2-backhaul-socks",
              "listen": "127.0.0.1",
              "port": 1081,
              "protocol": "socks",
              "settings": {"auth": "noauth", "udp": true},
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            }
          ],
          "outbounds": [
            {
              "tag": "api",
              "protocol": "freedom"
            },
            {
              "tag": "direct",
              "protocol": "freedom"
            },
            {
              "tag": "to-transit",
              "protocol": "vless",
              "settings": {
                "vnext": [
                  {
                    "address": "{{ .Values.gateway.splitter.transit.upstreamHost }}",
                    "port": 443,
                    "users": [
                      {
                        "id": "{{ .Values.gateway.splitter.transit.uuid }}",
                        "encryption": "none"
                      }
                    ]
                  }
                ]
              },
              "streamSettings": {
                "network": "xhttp",
                "security": "reality",
                "realitySettings": {
                  "fingerprint": "chrome",
                  "serverName": "{{ .Values.gateway.splitter.transit.serverName }}",
                  "publicKey": "{{ .Values.gateway.splitter.transit.publicKey | default .Values.controlPlane.env.realityPublicKey }}",
                  "shortId": "{{ .Values.gateway.splitter.transit.shortId }}"
                },
                "xhttpSettings": {
                  "mode": "packet-up",
                  "path": "/api/v1/update"
                }
              }
            },
            {
              "tag": "block",
              "protocol": "blackhole"
            }
          ],
          "routing": {
            "domainStrategy": "IPIfNonMatch",
            "rules": [
              {
                "type": "field",
                "inboundTag": ["api"],
                "outboundTag": "api"
              },
              {
                "type": "field",
                "ip": ["geoip:private"],
                "outboundTag": "block"
              },
              {
                "type": "field",
                "inboundTag": ["hy2-backhaul-socks"],
                "outboundTag": "to-transit"
              },
              {
                "type": "field",
                "inboundTag": ["entry-in", "vless-ws-in"],
                "domain": [
                  "geosite:category-ru",
                  "full:cp.cloudflare.com",
                  "regexp:(?i)\\.ru$",
                  "regexp:(?i)\\.su$",
                  "regexp:(?i)\\.xn--p1ai$"
                ],
                "outboundTag": "direct"
              },
              {
                "type": "field",
                "inboundTag": ["entry-in", "vless-ws-in"],
                "ip": ["geoip:ru"],
                "outboundTag": "direct"
              },
              {
                "type": "field",
                "inboundTag": ["entry-in", "vless-ws-in"],
                "outboundTag": "to-transit"
              }
            ]
          }
        }

    agent:
      enabled: true
      host: 0.0.0.0
      port: 8070
      role: VPS_E
      authToken: ""
      dataRoot: /var/lib/tracegate-agent
      dryRun: false
      runtimeMode: kubernetes
      # Enable Xray gRPC API mode to add/remove users without restarting Xray.
      xrayApiEnabled: false
      xrayApiServer: 127.0.0.1:8080
      xrayApiTimeoutSeconds: 3
      statsUrl: http://127.0.0.1:9999/traffic
      statsSecret: ""
      wgInterface: wg0
      wgExpectedPort: 51820
      reloadXrayCmd: sh -lc '(flock 9; sleep 1; pkill -HUP xray || true) 9>/tmp/xray-reload.lock'
      reloadHysteriaCmd: ""
      reloadWgCmd: ""

    agentDataHostPath: /var/lib/tracegate-agent

registration:
  enabled: true
  hook: true
  retrySeconds: 60

observability:
  enabled: false

  prometheus:
    image: prom/prometheus:v2.52.0
    pullPolicy: IfNotPresent
    scrapeInterval: 15s
    storage:
      enabled: false
      size: 10Gi
      storageClassName: ""

  grafana:
    image: grafana/grafana:11.2.0
    pullPolicy: IfNotPresent
    # Secret; provide via values override.
    adminPassword: ""
    resources: {}

  nodeExporter:
    enabled: true
    image: prom/node-exporter:v1.8.1
    pullPolicy: IfNotPresent

  cadvisor:
    enabled: true
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    pullPolicy: IfNotPresent

opsMaintenance:
  hostCleanup:
    enabled: false
    image: alpine:3.20
    imagePullPolicy: IfNotPresent
    schedule: "23 4 * * *"
    concurrencyPolicy: Forbid
    successfulJobsHistoryLimit: 1
    failedJobsHistoryLimit: 2
    ttlSecondsAfterFinished: 86400
    valuesBackupRetentionDays: 7
    imageOverlayRetentionDays: 14
    imageTarRetentionDays: 14
    tracegateBackupRetentionDays: 14
    xrayLogRetentionDays: 3
    tempRetentionDays: 2
