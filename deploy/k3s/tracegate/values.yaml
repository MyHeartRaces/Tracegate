namespace:
  name: tracegate

imagePullSecrets: []

controlPlane:
  enabled: true
  image:
    repository: ghcr.io/your-org/tracegate
    tag: "0.4"
    pullPolicy: IfNotPresent

  replicas:
    api: 1
    dispatcher: 1
    bot: 0

  dispatcherMetrics:
    enabled: true
    host: 0.0.0.0
    port: 9091

  service:
    type: ClusterIP
    port: 8080

  postgres:
    enabled: true
    image: postgres:16
    username: tracegate
    # Secret (provide via values override / .env-based deploy flow; never commit real value to git)
    password: ""
    database: tracegate
    storage: 10Gi
    storageClassName: ""

  externalDatabaseUrl: ""

  auth:
    # Secrets (provide via values override / .env-based deploy flow; never commit real values to git)
    apiInternalToken: ""
    agentAuthToken: ""
    botToken: ""

  # Telegram bot webhook mode avoids polling conflicts. It uses HTTPS on port 8443
  # (Telegram allows 8443) so it does not conflict with Xray/Hysteria on 443.
  botWebhook:
    enabled: false
    publicHost: ""     # e.g. t.example.com
    publicPort: 8443
    listenHost: 0.0.0.0
    listenPort: 8443
    # path/secretToken are generated and persisted as k8s secrets unless explicitly set.
    path: ""
    secretToken: ""
    uploadCert: true

  # /guide text can be overridden without touching DB by mounting it from a ConfigMap.
  # If disabled or text is empty, bot uses bundled default: bundles/bot/guide.md
  botGuide:
    enabled: false
    text: ""

  env:
    appEnv: prod
    logLevel: INFO
    publicBaseUrl: ""
    # JSON list, e.g. [123456789]. Used only to bootstrap role=superadmin on first user creation.
    superadminTelegramIds: []
    defaultVpsTHost: vps-t.example.com
    defaultVpsEHost: vps-e.example.com
    # Legacy REALITY material used as a fallback when per-role keys below are not set.
    realityPublicKey: ""
    realityShortId: ""
    # Optional per-role REALITY material. Required when B1 (direct to VPS-T) and B2 (chain via VPS-E)
    # terminate REALITY on different nodes with different keys/shortIds.
    realityPublicKeyVpsT: ""
    realityShortIdVpsT: ""
    realityPublicKeyVpsE: ""
    realityShortIdVpsE: ""
    wireguardServerPublicKey: ""
    vlessWsPath: /ws
    vlessWsTlsPort: 443
    grafana:
      enabled: false
      otpTtlSeconds: 300
      sessionTtlSeconds: 3600

  nodeSelector: {}
  tolerations: []
  affinity: {}
  terminationGracePeriodSeconds: 30
  pdb:
    enabled: true

  resources:
    api: {}
    dispatcher: {}
    bot: {}
    postgres: {}

gateway:
  enabled: true

  agentImage:
    repository: ghcr.io/your-org/tracegate
    tag: "0.4"
    pullPolicy: IfNotPresent

  splitter:
    transit:
      # Must match VPS-T static transit client id in Xray.
      uuid: "00000000-0000-4000-8000-000000000123"
      # If empty, falls back to controlPlane.env.realityPublicKey.
      publicKey: ""
      shortId: "0123456789abcdef"
      serverName: "splitter.wb.ru"
      upstreamHost: "vps-t.example.com"
      upstreamPort: 443

  # REALITY multi-inbound groups.
  # One external port remains fixed (:443), entry-mux routes by SNI to local Xray ports.
  # Keep this list aligned with static SNI catalog used by the bot/API.
  realityMultiInbound:
    groups:
      - id: shared-a
        port: 2501
        dest: splitter.wb.ru
        snis: ["splitter.wb.ru"]
      - id: shared-b
        port: 2502
        dest: st.ozone.ru
        snis: ["st.ozone.ru"]
      - id: shared-c
        port: 2503
        dest: speller.yandex.net
        snis: ["speller.yandex.net"]
      - id: mts-a
        port: 2504
        dest: a.wb.ru
        snis: ["a.wb.ru"]
      - id: mts-b
        port: 2505
        dest: alfabank.ru
        snis: ["alfabank.ru"]
      - id: megafon-a
        port: 2506
        dest: dzen.ru
        snis: ["dzen.ru"]
      - id: megafon-b
        port: 2507
        dest: ok.ru
        snis: ["ok.ru"]
      - id: t2-a
        port: 2508
        dest: yandex.ru
        snis: ["yandex.ru"]
      - id: t2-b
        port: 2509
        dest: sba.yandex.net
        snis: ["sba.yandex.net"]
      - id: tmobile-a
        port: 2510
        dest: login.vk.com
        snis: ["login.vk.com"]
      - id: tmobile-b
        port: 2511
        dest: goya.rutube.ru
        snis: ["goya.rutube.ru"]
      - id: rtk-a
        port: 2512
        dest: vk.com
        snis: ["vk.com"]
      - id: rtk-b
        port: 2513
        dest: www.wildberries.ru
        snis: ["www.wildberries.ru"]
      - id: yota-a
        port: 2514
        dest: queuev4.vk.com
        snis: ["queuev4.vk.com"]
      - id: yota-b
        port: 2515
        dest: www.kinopoisk.ru
        snis: ["www.kinopoisk.ru"]

  entryDecoyHtml: |
    <!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Secure Portal</title>
      <style>
        :root{color-scheme:light}
        *{box-sizing:border-box}
        body{margin:0;min-height:100vh;display:grid;place-items:center;background:#f3f5f7;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;color:#111827}
        main{width:min(440px,92vw);background:#fff;border:1px solid #d8dee6;border-radius:14px;padding:28px;box-shadow:0 18px 40px rgba(15,23,42,.08)}
        h1{margin:0 0 8px;font-size:24px;line-height:1.2;letter-spacing:.2px}
        p{margin:0 0 18px;color:#4b5563}
        label{display:block;font-size:13px;margin:12px 0 6px}
        input{width:100%;height:42px;padding:0 12px;border:1px solid #c7d2de;border-radius:10px;font-size:14px}
        button{margin-top:16px;width:100%;height:42px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
      </style>
    </head>
    <body>
      <main>
        <h1>Member Access</h1>
        <p>Please sign in to continue.</p>
        <form id="portal-login" autocomplete="off">
          <label for="login-user">Username</label>
          <input id="login-user" type="text" placeholder="Username">
          <label for="login-pass">Password</label>
          <input id="login-pass" type="password" placeholder="Password">
          <button type="submit">Sign in</button>
        </form>
      </main>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var form = document.getElementById("portal-login");
          if (!form) return;
          form.addEventListener("submit", function (event) {
            event.preventDefault();
            window.location.href = "/dashboard";
          });
        });
      </script>
    </body>
    </html>

  vpsT:
    enabled: true
    nodeSelector:
      tracegate.role: vps-t
    tolerations: []
    affinity: {}

    publicIPv4: 198.51.100.10
    fqdn: vps-t.example.com
    # Optional: a hostname expected to be proxied (e.g. Cloudflare orange cloud).
    # Use this for VLESS+WS+TLS if you want clients to connect via a proxied domain,
    # while keeping Reality/Hysteria on the direct fqdn/ip (DNS-only).
    proxyFqdn: ""

    hostNetwork: true
    shareProcessNamespace: true

    entryMux:
      image: nginx:1.24-alpine
      pullPolicy: IfNotPresent
      # Optional extra SNI hostnames that should be treated as VLESS+WS+TLS.
      wsSniHosts: []

    # TLS certificate used to terminate VLESS+WS+TLS on VPS-T.
    # Leave empty to generate and persist a self-signed cert in a k8s Secret.
    wsTls:
      crt: ""
      key: ""

    xray:
      image: ghcr.io/xtls/xray-core:latest
      pullPolicy: IfNotPresent
      config: |
        {
          "log": {"loglevel": "warning"},
          "api": {"tag":"api","services":["HandlerService","StatsService"]},
          "stats": {},
          "policy": {
            "levels": {
              "0": {
                "statsUserUplink": true,
                "statsUserDownlink": true
              }
            },
            "system": {
              "statsInboundUplink": true,
              "statsInboundDownlink": true,
              "statsOutboundUplink": true,
              "statsOutboundDownlink": true
            }
          },
          "inbounds": [
            {
              "tag": "api",
              "listen": "127.0.0.1",
              "port": 8080,
              "protocol": "dokodemo-door",
              "settings": {"address": "127.0.0.1"}
            },
            {
              "tag": "vless-reality-in",
              "listen": "127.0.0.1",
              "port": 2443,
              "protocol": "vless",
              "settings": {
                "clients": [
                  {
                    "id": "{{ .Values.gateway.splitter.transit.uuid }}",
                    "email": "vps-e-transit"
                  }
                ],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "xhttp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "splitter.wb.ru:443",
                  "xver": 0,
                  "serverNames": ["splitter.wb.ru"],
                  "privateKey": "REPLACE_PRIVATE_KEY",
                  "shortIds": ["0123456789abcdef"]
                },
                "xhttpSettings": {
                  "mode": "packet-up",
                  "path": "/api/v1/update"
                }
              }
            },
            {
              "tag": "vless-ws-in",
              "listen": "127.0.0.1",
              "port": 10000,
              "protocol": "vless",
              "settings": {
                "clients": [],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "ws",
                "security": "none",
                "wsSettings": {
                  "path": "{{ .Values.controlPlane.env.vlessWsPath | default "/ws" }}"
                }
              },
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            },
            {
              "tag": "hy2-backhaul-socks",
              "listen": "127.0.0.1",
              "port": 1081,
              "protocol": "socks",
              "settings": {"auth": "noauth", "udp": true},
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            }
          ],
          "outbounds": [
            {"protocol": "freedom", "tag": "api"},
            {"protocol": "freedom", "tag": "direct"}
          ],
          "routing": {
            "rules": [
              {"type": "field", "inboundTag": ["api"], "outboundTag": "api"},
              {"type": "field", "inboundTag": ["vless-reality-in", "vless-ws-in"], "outboundTag": "direct"}
            ]
          }
        }

    hysteria:
      image: tobyxdd/hysteria:v2
      pullPolicy: IfNotPresent
      config: |
        listen: :443
        acme:
          domains:
            - example.com
          email: admin@example.com
        auth:
          type: userpass
          userpass:
            bootstrap: bootstrap-password
        masquerade:
          type: file
          file:
            dir: /var/www/decoy
        trafficStats:
          listen: 127.0.0.1:9999
          secret: CHANGE_ME_HYSTERIA_STATS

    wireguard:
      image: ghcr.io/your-org/tracegate-wireguard:0.4
      pullPolicy: IfNotPresent
      interface: wg0
      config: |
        [Interface]
        Address = 10.70.0.1/24
        ListenPort = 51820
        PrivateKey = REPLACE_WG_PRIVATE_KEY
        SaveConfig = false

    decoyHtml: |
      <!doctype html>
      <html><head><meta charset="utf-8"><title>Tracegate</title></head><body><h1>It works.</h1></body></html>

    hysteriaTls:
      crt: ""
      key: ""

    agent:
      enabled: true
      host: 0.0.0.0
      port: 8070
      role: VPS_T
      authToken: ""
      dataRoot: /var/lib/tracegate-agent
      dryRun: false
      runtimeMode: kubernetes
      # Enable Xray gRPC API mode to add/remove users without restarting Xray.
      xrayApiEnabled: false
      xrayApiServer: 127.0.0.1:8080
      xrayApiTimeoutSeconds: 3
      statsUrl: http://127.0.0.1:9999/traffic
      statsSecret: ""
      wgInterface: wg0
      wgExpectedPort: 51820
      # Coalesce burst events into a single xray reload and avoid CrashLoopBackOff.
      reloadXrayCmd: sh -lc '(flock 9; sleep 1; pkill -HUP xray || true) 9>/tmp/xray-reload.lock'
      # Prefer graceful config reload to reduce client interruption.
      reloadHysteriaCmd: pkill -HUP hysteria || true
      # Apply wg-quick config by stripping it to wg format and syncing live interface.
      reloadWgCmd: wg-quick strip /etc/wireguard/wg0.conf | wg syncconf wg0 /dev/fd/0 || true

    agentDataHostPath: /var/lib/tracegate-agent

  vpsE:
    enabled: true
    nodeSelector:
      tracegate.role: vps-e
    tolerations: []
    affinity: {}

    publicIPv4: 198.51.100.20
    fqdn: vps-e.example.com
    proxyFqdn: ""

    hostNetwork: true
    shareProcessNamespace: true

    entryMux:
      image: nginx:1.24-alpine
      pullPolicy: IfNotPresent
      # Optional extra SNI hostnames that should be treated as VLESS+WS+TLS.
      # `proxyFqdn` is included automatically (if set).
      wsSniHosts: []

    # TLS certificate used to terminate VLESS+WS+TLS on VPS-E (chain mode / splitter).
    # Leave empty to generate and persist a self-signed cert in a k8s Secret.
    wsTls:
      crt: ""
      key: ""

    # Optional Hysteria2 entry on VPS-E (UDP/443) with backhaul via local Xray -> VPS-T REALITY transit.
    hysteria:
      enabled: true
      image: tobyxdd/hysteria:v2
      pullPolicy: IfNotPresent
      config: |
        listen: :443
        tls:
          cert: /etc/hysteria/tls/tls.crt
          key: /etc/hysteria/tls/tls.key
        auth:
          type: userpass
          userpass:
            bootstrap: bootstrap-password
        masquerade:
          type: file
          file:
            dir: /var/www/decoy
        outbounds:
          - name: xray_transit
            type: socks5
            socks5:
              addr: 127.0.0.1:1081

    # "tcpForward" is the legacy v0.1 chain implementation: L4 forward :443 -> VPS-T:443.
    # "xray" enables VPS-E user mapping and split-routing (RU/domestic via VPS-E, rest via VPS-T transit).
    mode: tcpForward
    tcpForward:
      image: haproxy:2.9-alpine
      pullPolicy: IfNotPresent
      upstreamHost: vps-t.example.com
      upstreamPort: 443

    xray:
      image: ghcr.io/xtls/xray-core:latest
      pullPolicy: IfNotPresent
      # Splitter mode uses gateway.splitter.transit.* values for VPS-E -> VPS-T transit.
      config: |
        {
          "log": {"loglevel": "warning"},
          "api": {"tag":"api","services":["HandlerService","StatsService"]},
          "stats": {},
          "policy": {
            "levels": {
              "0": {
                "statsUserUplink": true,
                "statsUserDownlink": true
              }
            },
            "system": {
              "statsInboundUplink": true,
              "statsInboundDownlink": true,
              "statsOutboundUplink": true,
              "statsOutboundDownlink": true
            }
          },
          "inbounds": [
            {
              "tag": "api",
              "listen": "127.0.0.1",
              "port": 8080,
              "protocol": "dokodemo-door",
              "settings": {"address": "127.0.0.1"}
            },
            {
              "tag": "entry-in",
              "listen": "127.0.0.1",
              "port": 2443,
              "protocol": "vless",
              "settings": {"clients": [], "decryption": "none"},
              "streamSettings": {
                "network": "xhttp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "splitter.wb.ru:443",
                  "xver": 0,
                  "serverNames": ["splitter.wb.ru"],
                  "privateKey": "REPLACE_PRIVATE_KEY",
                  "shortIds": ["fedcba9876543210"]
                },
                "xhttpSettings": {
                  "mode": "packet-up",
                  "path": "/api/v1/update"
                }
              },
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            },
            {
              "tag": "vless-ws-in",
              "listen": "127.0.0.1",
              "port": 10000,
              "protocol": "vless",
              "settings": {"clients": [], "decryption": "none"},
              "streamSettings": {
                "network": "ws",
                "security": "none",
                "wsSettings": {
                  "path": "{{ .Values.controlPlane.env.vlessWsPath | default "/ws" }}"
                }
              },
              "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
              }
            }
          ],
          "outbounds": [
            {
              "tag": "api",
              "protocol": "freedom"
            },
            {
              "tag": "direct",
              "protocol": "freedom"
            },
            {
              "tag": "to-transit",
              "protocol": "vless",
              "settings": {
                "vnext": [
                  {
                    "address": "{{ .Values.gateway.splitter.transit.upstreamHost }}",
                    "port": 443,
                    "users": [
                      {
                        "id": "{{ .Values.gateway.splitter.transit.uuid }}",
                        "encryption": "none"
                      }
                    ]
                  }
                ]
              },
              "streamSettings": {
                "network": "xhttp",
                "security": "reality",
                "realitySettings": {
                  "fingerprint": "chrome",
                  "serverName": "{{ .Values.gateway.splitter.transit.serverName }}",
                  "publicKey": "{{ .Values.gateway.splitter.transit.publicKey | default .Values.controlPlane.env.realityPublicKey }}",
                  "shortId": "{{ .Values.gateway.splitter.transit.shortId }}"
                },
                "xhttpSettings": {
                  "mode": "packet-up",
                  "path": "/api/v1/update"
                }
              }
            },
            {
              "tag": "block",
              "protocol": "blackhole"
            }
          ],
          "routing": {
            "domainStrategy": "IPIfNonMatch",
            "rules": [
              {
                "type": "field",
                "inboundTag": ["api"],
                "outboundTag": "api"
              },
              {
                "type": "field",
                "ip": ["geoip:private"],
                "outboundTag": "block"
              },
              {
                "type": "field",
                "inboundTag": ["hy2-backhaul-socks"],
                "outboundTag": "to-transit"
              },
              {
                "type": "field",
                "inboundTag": ["entry-in", "vless-ws-in"],
                "domain": [
                  "geosite:category-ru",
                  "full:cp.cloudflare.com",
                  "regexp:(?i)\\.ru$",
                  "regexp:(?i)\\.su$",
                  "regexp:(?i)\\.xn--p1ai$"
                ],
                "outboundTag": "direct"
              },
              {
                "type": "field",
                "inboundTag": ["entry-in", "vless-ws-in"],
                "ip": ["geoip:ru"],
                "outboundTag": "direct"
              },
              {
                "type": "field",
                "inboundTag": ["entry-in", "vless-ws-in"],
                "outboundTag": "to-transit"
              }
            ]
          }
        }

    agent:
      enabled: true
      host: 0.0.0.0
      port: 8070
      role: VPS_E
      authToken: ""
      dataRoot: /var/lib/tracegate-agent
      dryRun: false
      runtimeMode: kubernetes
      # Enable Xray gRPC API mode to add/remove users without restarting Xray.
      xrayApiEnabled: false
      xrayApiServer: 127.0.0.1:8080
      xrayApiTimeoutSeconds: 3
      statsUrl: http://127.0.0.1:9999/traffic
      statsSecret: ""
      wgInterface: wg0
      wgExpectedPort: 51820
      reloadXrayCmd: sh -lc '(flock 9; sleep 1; pkill -HUP xray || true) 9>/tmp/xray-reload.lock'
      reloadHysteriaCmd: pkill -HUP hysteria || true
      reloadWgCmd: ""

    agentDataHostPath: /var/lib/tracegate-agent

registration:
  enabled: true
  hook: true
  retrySeconds: 60

observability:
  enabled: false

  prometheus:
    image: prom/prometheus:v2.52.0
    pullPolicy: IfNotPresent
    scrapeInterval: 15s
    storage:
      enabled: false
      size: 10Gi
      storageClassName: ""

  grafana:
    image: grafana/grafana:11.2.0
    pullPolicy: IfNotPresent
    # Secret; provide via values override.
    adminPassword: ""
    resources: {}

  nodeExporter:
    enabled: true
    image: prom/node-exporter:v1.8.1
    pullPolicy: IfNotPresent

  cadvisor:
    enabled: true
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    pullPolicy: IfNotPresent
